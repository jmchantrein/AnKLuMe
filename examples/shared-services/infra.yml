---
# infra.yml â€” Primary Source of Truth (PSOT)
#
# Shared services example: dedicated CUPS container with USB printer
# passthrough and network printer access via macvlan.
#
# IPs: anklume -> 10.100.0.x (admin)
#       shared  -> 10.120.x.x (semi-trusted)
#       pro     -> 10.110.x.x (trusted)
#       perso   -> 10.120.x.x (semi-trusted)

project_name: shared-services-example

global:
  addressing:
    base_octet: 10
    zone_base: 100
  default_os_image: "images:debian/13"
  default_connection: community.general.incus
  default_user: root

domains:
  anklume:
    trust_level: admin
    description: "Administration and orchestration"
    machines:
      anklume-instance:
        description: "Ansible controller"
        type: lxc
        config:
          security.nesting: "true"
        roles:
          - base_system

  shared:
    trust_level: semi-trusted
    description: "User-facing shared services (print, DNS, VPN)"
    machines:
      shared-print:
        description: "CUPS print server"
        type: lxc
        roles:
          - base_system

  pro:
    trust_level: trusted
    description: "Professional workstation domain"
    machines:
      pro-dev:
        description: "Development workstation"
        type: lxc
        roles:
          - base_system

  perso:
    trust_level: semi-trusted
    description: "Personal domain"
    machines:
      perso-desktop:
        description: "Personal desktop"
        type: lxc
        roles:
          - base_system

# Allow pro and perso domains to access CUPS via IPP (port 631).
# After `anklume domain apply`, run:
#   anklume domain apply-print I=shared-print
# to install CUPS, then add printers:
#   scripts/cups-setup.sh add-usb shared-print --vendor 04b8 --product 0005
#   scripts/cups-setup.sh add-network shared-print --nic-parent enp3s0
network_policies:
  - description: "Pro domain prints via CUPS"
    from: pro
    to: shared
    ports: [631]
    protocol: tcp

  - description: "Perso domain prints via CUPS"
    from: perso
    to: shared
    ports: [631]
    protocol: tcp
