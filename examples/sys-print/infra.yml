---
# infra.yml â€” Primary Source of Truth (PSOT)
#
# Print service example: dedicated CUPS container with USB printer
# passthrough and network printer access via macvlan.
#
# IPs: anklume -> 10.100.0.x (admin)
#       print-service/pro -> 10.110.x.x (trusted)
#       perso -> 10.120.0.x (semi-trusted)

project_name: sys-print-example

global:
  addressing:
    base_octet: 10
    zone_base: 100
  default_os_image: "images:debian/13"
  default_connection: community.general.incus
  default_user: root

domains:
  anklume:
    trust_level: admin
    description: "Administration and orchestration"
    machines:
      anklume-instance:
        description: "Ansible controller"
        type: lxc
        config:
          security.nesting: "true"
        roles:
          - base_system

  print-service:
    trust_level: trusted
    description: "Dedicated print service domain"
    machines:
      sys-print:
        description: "CUPS print server"
        type: lxc
        roles:
          - base_system

  pro:
    trust_level: trusted
    description: "Professional workstation domain"
    machines:
      pro-dev:
        description: "Development workstation"
        type: lxc
        roles:
          - base_system

  perso:
    trust_level: semi-trusted
    description: "Personal domain"
    machines:
      perso-desktop:
        description: "Personal desktop"
        type: lxc
        roles:
          - base_system

# Allow pro and perso domains to access CUPS via IPP (port 631).
# After `make apply`, run:
#   make apply-print I=sys-print
# to install CUPS, then add printers:
#   scripts/sys-print.sh add-usb sys-print --vendor 04b8 --product 0005
#   scripts/sys-print.sh add-network sys-print --nic-parent enp3s0
network_policies:
  - description: "Pro domain prints via CUPS"
    from: pro
    to: print-service
    ports: [631]
    protocol: tcp

  - description: "Perso domain prints via CUPS"
    from: perso
    to: print-service
    ports: [631]
    protocol: tcp
