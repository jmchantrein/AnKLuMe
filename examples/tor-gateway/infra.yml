---
# infra.yml â€” Primary Source of Truth (PSOT)
#
# Describes your infrastructure at a high level. After editing, run:
#   make sync        # Generate/update Ansible files
#   make apply       # Apply to Incus
#
# See docs/SPEC.md section 5 for the full format reference.

# Tor gateway example: route traffic from selected domains through
# a Tor transparent proxy for anonymous internet access.

project_name: tor-gateway-example

global:
  base_subnet: "10.100"
  default_os_image: "images:debian/13"
  default_connection: community.general.incus
  default_user: root

domains:
  admin:
    description: "Administration and orchestration"
    subnet_id: 0
    trust_level: admin
    machines:
      admin-ansible:
        description: "Ansible controller"
        type: lxc
        ip: "10.100.0.10"
        config:
          security.nesting: "true"
        roles:
          - base_system

  tor-gateway:
    description: "Tor transparent proxy gateway"
    subnet_id: 5
    trust_level: untrusted
    ephemeral: true
    machines:
      tor-gw:
        description: "Tor transparent proxy"
        type: lxc
        ip: "10.100.5.10"
        roles:
          - base_system

  anonymous:
    description: "Domain routed through Tor for anonymous browsing"
    subnet_id: 6
    trust_level: untrusted
    ephemeral: true
    machines:
      anon-browser:
        description: "Anonymous browsing container"
        type: lxc
        ip: "10.100.6.10"
        roles:
          - base_system

# Allow the anonymous domain to route traffic through the Tor gateway.
# After `make apply`, run:
#   make apply-tor I=tor-gw
# to install and configure the Tor transparent proxy inside the container.
network_policies:
  - description: "Anonymous domain routes through Tor gateway"
    from: anonymous
    to: tor-gateway
    ports: all
    bidirectional: true
