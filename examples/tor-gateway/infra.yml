---
# infra.yml â€” Primary Source of Truth (PSOT)
#
# Tor gateway example: route traffic from selected domains through
# a Tor transparent proxy for anonymous internet access.
#
# IPs: anklume -> 10.100.0.x (admin)
#       tor-gateway/anonymous -> 10.140.x.x (untrusted)

project_name: tor-gateway-example

global:
  addressing:
    base_octet: 10
    zone_base: 100
  default_os_image: "images:debian/13"
  default_connection: community.general.incus
  default_user: root

domains:
  anklume:
    trust_level: admin
    description: "Administration and orchestration"
    machines:
      anklume-instance:
        description: "Ansible controller"
        type: lxc
        config:
          security.nesting: "true"
        roles:
          - base_system

  tor-gateway:
    trust_level: untrusted
    description: "Tor transparent proxy gateway"
    ephemeral: true
    machines:
      tor-gw:
        description: "Tor transparent proxy"
        type: lxc
        roles:
          - base_system

  anonymous:
    trust_level: untrusted
    description: "Domain routed through Tor for anonymous browsing"
    ephemeral: true
    machines:
      anon-browser:
        description: "Anonymous browsing container"
        type: lxc
        roles:
          - base_system

# Allow the anonymous domain to route traffic through the Tor gateway.
# After `anklume domain apply`, run:
#   anklume domain apply-tor I=tor-gw
# to install and configure the Tor transparent proxy inside the container.
network_policies:
  - description: "Anonymous domain routes through Tor gateway"
    from: anonymous
    to: tor-gateway
    ports: all
    bidirectional: true
