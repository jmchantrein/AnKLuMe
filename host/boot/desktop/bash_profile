# shellcheck shell=bash
# anklume: auto-start desktop environment from kernel cmdline
# Parsed parameter: anklume.desktop=<sway|labwc|kde|1>
# Only activates on tty1 with no existing Wayland session

# Auto-detect locale from keyboard layout
# Fixes foot "'C' is not a UTF-8 locale" warning
if [ -z "$LANG" ] || [ "$LANG" = "C" ]; then
    if grep -q '^KEYMAP=fr' /etc/vconsole.conf 2>/dev/null; then
        export LANG=fr_FR.UTF-8
    else
        export LANG=en_US.UTF-8
    fi
fi

if [ "$(tty)" = "/dev/tty1" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    # Parse anklume.desktop=<de> from kernel cmdline
    ANKLUME_DE=""
    for param in $(cat /proc/cmdline); do
        case "$param" in
            anklume.desktop=*) ANKLUME_DE="${param#anklume.desktop=}" ;;
        esac
    done

    # Skip desktop if user opted out (touch ~/.anklume-console)
    if [ -f "$HOME/.anklume-console" ]; then
        echo "[anklume] Console mode (~/.anklume-console exists). Remove to restore desktop."
        ANKLUME_DE=""
    fi

    # Splash: show ASCII art + random quote on every desktop boot
    if [ -x /opt/anklume/host/boot/desktop/anklume-splash.sh ]; then
        /opt/anklume/host/boot/desktop/anklume-splash.sh
    fi

    # Keyboard layout for Wayland (auto-detect from vconsole.conf)
    if [ -z "$XKB_DEFAULT_LAYOUT" ]; then
        if grep -q '^KEYMAP=fr' /etc/vconsole.conf 2>/dev/null; then
            export XKB_DEFAULT_LAYOUT=fr
        fi
    fi

    # NVIDIA: use Vulkan renderer for proprietary driver compatibility
    if lsmod | grep -q '^nvidia '; then
        export WLR_RENDERER=vulkan
    fi

    export XDG_SESSION_TYPE=wayland

    case "$ANKLUME_DE" in
        sway|1)
            exec sway 2>/dev/null
            ;;
        labwc)
            exec labwc 2>/dev/null
            ;;
        kde)
            # KDE Plasma manages its own renderer
            unset WLR_RENDERER
            exec startplasma-wayland 2>/dev/null
            ;;
    esac
fi
