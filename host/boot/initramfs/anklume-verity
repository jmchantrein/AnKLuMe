#!/bin/sh

# anklume dm-verity Hook for initramfs-tools
# Sets up dm-verity root filesystem protection during early boot
# Reads kernel cmdline: anklume.verity_hash=<hash> anklume.slot=A|B anklume.boot_mode=iso|raw

PREREQ=""

prereq() {
	echo "$PREREQ"
}

go() {
	# Read kernel cmdline parameters
	VERITY_HASH=""
	SLOT="A"
	BOOT_MODE="raw"

	# cmdline is space-separated words, not lines — word splitting is intentional
	# shellcheck disable=SC2013
	for param in $(cat /proc/cmdline); do
		case "$param" in
			anklume.verity_hash=*)
				VERITY_HASH="${param#anklume.verity_hash=}"
				;;
			anklume.slot=*)
				SLOT="${param#anklume.slot=}"
				;;
			anklume.boot_mode=*)
				BOOT_MODE="${param#anklume.boot_mode=}"
				;;
		esac
	done

	# Validate parameters
	if [ -z "$VERITY_HASH" ]; then
		log_warning_msg "anklume: No verity hash specified in kernel cmdline"
		return 0
	fi

	log_begin_msg "anklume: Setting up dm-verity for slot $SLOT (mode: $BOOT_MODE)"

	if [ "$BOOT_MODE" = "iso" ]; then
		# ── ISO mode: mount ISO by label, use squashfs + verity files ──
		mkdir -p /run/anklume-iso
		ISO_DEV=$(blkid -L "ANKLUME-LIVE" 2>/dev/null)
		if [ -z "$ISO_DEV" ]; then
			log_failure_msg "anklume: Could not find ISO device (label: ANKLUME-LIVE)"
			return 1
		fi

		log_success_msg "anklume: Found ISO device at $ISO_DEV"
		if ! mount -o ro "$ISO_DEV" /run/anklume-iso 2>/dev/null; then
			log_failure_msg "anklume: Failed to mount ISO device"
			return 1
		fi

		SQUASHFS="/run/anklume-iso/live/rootfs.squashfs"
		VERITY_FILE="/run/anklume-iso/live/rootfs.verity"

		if [ ! -f "$SQUASHFS" ] || [ ! -f "$VERITY_FILE" ]; then
			log_failure_msg "anklume: Missing squashfs or verity file in ISO"
			return 1
		fi

		# Create loopback devices for squashfs (data) and verity hash
		DATA_LOOP=$(losetup --find --show --read-only "$SQUASHFS")
		HASH_LOOP=$(losetup --find --show --read-only "$VERITY_FILE")

		log_success_msg "anklume: Data loop: $DATA_LOOP, Hash loop: $HASH_LOOP"

		if ! veritysetup create anklume-root "$DATA_LOOP" "$HASH_LOOP" "$VERITY_HASH" \
			--hash=sha256 --data-block-size=4096 --hash-block-size=4096; then
			log_failure_msg "anklume: Failed to activate dm-verity device (ISO mode)"
			losetup -d "$DATA_LOOP" 2>/dev/null || true
			losetup -d "$HASH_LOOP" 2>/dev/null || true
			return 1
		fi
	else
		# ── Raw mode: partition-based approach ──
		case "$SLOT" in
			A)
				OS_PARTITION_NAME="ANKLUME-OS-A"
				;;
			B)
				OS_PARTITION_NAME="ANKLUME-OS-B"
				;;
			*)
				log_failure_msg "anklume: Invalid slot '$SLOT' (expected A or B)"
				return 1
				;;
		esac

		OS_PARTITION=$(blkid -L "$OS_PARTITION_NAME" 2>/dev/null)
		if [ -z "$OS_PARTITION" ]; then
			log_failure_msg "anklume: Could not find partition '$OS_PARTITION_NAME'"
			return 1
		fi

		log_success_msg "anklume: Found OS partition at $OS_PARTITION"

		# Note: raw mode uses same partition for data and hash (future: separate hash partition)
		if ! veritysetup create anklume-root "$OS_PARTITION" "$OS_PARTITION" "$VERITY_HASH" \
			--hash=sha256 --data-block-size=4096 --hash-block-size=4096; then
			log_failure_msg "anklume: Failed to activate dm-verity device"
			return 1
		fi
	fi

	log_success_msg "anklume: dm-verity device activated successfully"

	# Set root device to the verity device mapping
	export ROOT="/dev/mapper/anklume-root"

	log_success_msg "anklume: Root device set to $ROOT"
	return 0
}

case $1 in
	prereq)
		prereq
		;;
	go)
		go
		;;
	*)
		echo "Usage: $0 {prereq|go}"
		exit 1
		;;
esac
