#!/usr/bin/ash
# shellcheck shell=dash
# anklume-toram: Copy squashfs root image to RAM during early boot
# This hook enables loading the root filesystem into RAM for faster performance
# Set kernel parameter anklume.toram=1 to enable

run_hook() {
    # Check if anklume.toram is enabled in kernel command line
    if ! grep -q "anklume.toram=1" /proc/cmdline; then
        return 0
    fi

    # Detect boot mode
    BOOT_MODE="raw"
    # shellcheck disable=SC2013
    for param in $(cat /proc/cmdline); do
        case "$param" in
            anklume.boot_mode=*)
                BOOT_MODE="${param#anklume.boot_mode=}"
                ;;
        esac
    done

    msg "anklume: Detected anklume.toram=1 (mode: $BOOT_MODE), copying root to RAM..."

    # Create tmpfs mount point
    if ! [ -d /run/anklume-toram ]; then
        if ! mkdir -p /run/anklume-toram; then
            warn "anklume: Failed to create /run/anklume-toram directory"
            return 1
        fi
    fi

    # Mount tmpfs with appropriate size
    if ! mount -t tmpfs -o mode=755,size=70% tmpfs /run/anklume-toram; then
        warn "anklume: Failed to mount tmpfs at /run/anklume-toram"
        return 1
    fi

    msg "anklume: tmpfs mounted at /run/anklume-toram"

    # Find the squashfs root image
    ROOT_IMAGE=""

    if [ "$BOOT_MODE" = "iso" ]; then
        # ISO mode: check ISO mount from anklume-verity hook first
        if [ -f /run/anklume-iso/live/rootfs.squashfs ]; then
            ROOT_IMAGE="/run/anklume-iso/live/rootfs.squashfs"
        fi
    fi

    # Fallback: search common boot locations
    if [ -z "$ROOT_IMAGE" ]; then
        for location in /run/anklume-iso/live /boot /cdrom /media /mnt; do
            if [ -d "$location" ]; then
                for image in "$location"/*.squashfs "$location"/*.img; do
                    if [ -f "$image" ] && file "$image" | grep -q "Squashfs"; then
                        ROOT_IMAGE="$image"
                        break 2
                    fi
                done
            fi
        done
    fi

    if [ -z "$ROOT_IMAGE" ]; then
        warn "anklume: No squashfs root image found in boot media"
        umount /run/anklume-toram
        return 1
    fi

    msg "anklume: Found root image at $ROOT_IMAGE"
    msg "anklume: Copying $ROOT_IMAGE to RAM (this may take a moment)..."

    # Copy the squashfs image to tmpfs
    if ! cp "$ROOT_IMAGE" /run/anklume-toram/root.squashfs 2>/dev/null; then
        warn "anklume: Failed to copy root image to tmpfs"
        umount /run/anklume-toram
        return 1
    fi

    msg "anklume: Root image copied to /run/anklume-toram/root.squashfs"

    # Update ROOT environment variable to point to the RAM-based copy
    export ROOT="/run/anklume-toram/root.squashfs"
    msg "anklume: ROOT updated to use RAM copy"

    # Store configuration for rootfs script to use
    mkdir -p /conf
    echo "ANKLUME_TORAM_ROOT=/run/anklume-toram/root.squashfs" >> /conf/anklume.conf

    msg "anklume: Boot-to-RAM setup complete"

    return 0
}
