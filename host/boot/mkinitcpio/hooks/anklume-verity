#!/usr/bin/ash
# shellcheck shell=dash
# anklume-verity: Live ISO boot — find device, mount squashfs, overlay, optional toram
# Follows the archiso mount_handler pattern.

run_hook() {
    # Parse kernel cmdline
    # shellcheck disable=SC2013
    for param in $(cat /proc/cmdline); do
        case "$param" in
            anklume.boot_mode=*) anklume_boot_mode="${param#anklume.boot_mode=}" ;;
            anklume.toram=*)     anklume_toram="${param#anklume.toram=}" ;;
        esac
    done

    # Only activate for ISO boot mode
    if [ "$anklume_boot_mode" = "iso" ]; then
        export mount_handler="anklume_mount_handler"
    fi
}

anklume_mount_handler() {
    local newroot="${1}"

    msg "anklume: Starting live ISO boot..."

    # ── 1. Find and mount ISO device ──
    mkdir -p /run/anklume/bootmnt

    local tries=0 ISO_DEV=""
    while [ $tries -lt 30 ]; do
        ISO_DEV=$(blkid -L "ANKLUME-LIVE" 2>/dev/null)
        [ -n "$ISO_DEV" ] && break
        tries=$((tries + 1))
        sleep 1
    done

    if [ -z "$ISO_DEV" ]; then
        err "anklume: Could not find ISO device (label: ANKLUME-LIVE)"
        launch_interactive_shell
        return 1
    fi

    msg "anklume: Found ISO at $ISO_DEV"
    mount -t iso9660 -o ro "$ISO_DEV" /run/anklume/bootmnt
    if [ $? -ne 0 ]; then
        err "anklume: Failed to mount ISO"
        launch_interactive_shell
        return 1
    fi

    local squashfs="/run/anklume/bootmnt/live/rootfs.squashfs"
    if [ ! -f "$squashfs" ]; then
        err "anklume: rootfs.squashfs not found in ISO"
        launch_interactive_shell
        return 1
    fi

    # ── 2. Optional: copy squashfs to RAM ──
    if [ "$anklume_toram" = "1" ]; then
        msg "anklume: Copying squashfs to RAM (this may take a moment)..."
        mkdir -p /run/anklume/copytoram
        mount -t tmpfs -o "size=75%,mode=0755" copytoram /run/anklume/copytoram
        if cp -- "$squashfs" /run/anklume/copytoram/rootfs.squashfs; then
            squashfs="/run/anklume/copytoram/rootfs.squashfs"
            msg "anklume: Squashfs copied to RAM"
            # Release the ISO device
            umount /run/anklume/bootmnt
            msg "anklume: ISO device released (running from RAM)"
        else
            msg "anklume: WARNING — toram copy failed, booting from ISO directly"
            umount /run/anklume/copytoram 2>/dev/null
        fi
    fi

    # ── 3. Loop-mount squashfs read-only ──
    mkdir -p /run/anklume/rootfs
    local loopdev
    loopdev="$(losetup --find --show --read-only -- "$squashfs")"
    mount -t squashfs -o ro "$loopdev" /run/anklume/rootfs
    if [ $? -ne 0 ]; then
        err "anklume: Failed to mount squashfs"
        launch_interactive_shell
        return 1
    fi
    msg "anklume: Squashfs mounted read-only"

    # ── 4. Create COW space (tmpfs) ──
    mkdir -p /run/anklume/cowspace
    mount -t tmpfs -o "size=50%,mode=0755" cowspace /run/anklume/cowspace
    mkdir -p /run/anklume/cowspace/upper /run/anklume/cowspace/work

    # ── 5. Mount overlayfs as new root ──
    mount -t overlay -o \
        "lowerdir=/run/anklume/rootfs,upperdir=/run/anklume/cowspace/upper,workdir=/run/anklume/cowspace/work" \
        rootfs "${newroot}"
    if [ $? -ne 0 ]; then
        err "anklume: Failed to mount overlayfs"
        launch_interactive_shell
        return 1
    fi

    msg "anklume: Overlay root mounted (squashfs ro + tmpfs rw)"
    msg "anklume: Boot complete, switching to real root..."
}
