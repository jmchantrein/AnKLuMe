---
# infra.yml — Primary Source of Truth (PSOT)
#
# Describes your infrastructure at a high level. After editing, run:
#   make sync        # Generate/update Ansible files
#   make apply       # Apply to Incus
#
# See docs/SPEC.md section 5 for the full format reference.

# IMPORTANT: Addressing convention (ADR-038)
#
# IP addresses encode trust zones: 10.<zone_base+offset>.<domain_seq>.<host>/24
# Trust levels: admin(+0), trusted(+10), semi-trusted(+20), untrusted(+40), disposable(+50)
# Default zone_base is 100, so semi-trusted domains get 10.120.x.x
#
# Choose a zone_base that does NOT conflict with your existing LAN.
# Default 100 avoids 10.0-60.x.x used by enterprise VPNs, home routers,
# and container orchestrators.
#
# IPs are auto-assigned within each domain subnet (.1-.99 static range).
# Gateway is always .254 (immutable convention).

project_name: my-infra

global:
  addressing:
    base_octet: 10        # Always 10 (RFC 1918)
    zone_base: 100        # Starting second octet (default: 100)
    zone_step: 10         # Gap between zones (default: 10)
  default_os_image: "images:debian/13"
  # default_connection and default_user are stored in group_vars/all.yml as
  # psot_default_connection / psot_default_user (informational only).
  # They are NOT injected as ansible_connection / ansible_user into domain
  # group_vars because Ansible inventory variables override play-level
  # keywords, which would break infrastructure roles that need
  # connection: local. Connection is controlled at the playbook level.
  default_connection: community.general.incus
  default_user: root

domains:
  anklume:
    description: "Administration and orchestration"
    trust_level: admin
    ephemeral: false  # Protected — cannot be accidentally deleted
    machines:
      anklume-instance:
        description: "Ansible controller — drives the whole infra"
        type: lxc
        config:
          security.nesting: "true"
        roles:
          - base_system

  work:
    description: "Professional workspace"
    trust_level: semi-trusted
    ephemeral: false
    machines:
      work-dev:
        description: "Development workspace"
        type: lxc
        config:
          limits.cpu: "4"
          limits.memory: "8GiB"
        roles:
          - base_system

  # Example: an ephemeral sandbox domain for testing
  # sandbox:
  #   description: "Disposable test environment"
  #   trust_level: disposable
  #   ephemeral: true  # Can be freely destroyed and recreated
  #   machines:
  #     sandbox-test:
  #       description: "Throwaway test container"
  #       type: lxc
