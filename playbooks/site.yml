---
# site.yml — Master playbook for AnKLuMe infrastructure
#
# Architecture pattern:
#   - hosts: all — each host provides its own PSOT variables
#   - connection: local — all Incus commands run on the controller
#     (admin-ansible) which has the Incus socket mounted
#   - No run_once — each host executes the roles for its own domain;
#     the reconciliation pattern (check → create if missing) ensures
#     idempotence across hosts sharing the same domain
#
# This follows the standard Ansible pattern for API-driven infrastructure
# management (similar to cloud/network device management from a controller).
# See ADR-015 in docs/ARCHITECTURE.md.
#
# Concurrency note:
#   With forks > 1, multiple hosts may attempt to create the same resource
#   simultaneously. The reconciliation pattern handles this gracefully in
#   most cases. If strict sequential execution is needed, uncomment the
#   serial: 1 line below.
#
# Usage:
#   make apply                     # Full infrastructure
#   make apply-infra               # Infrastructure only (--tags infra)
#   make apply-limit G=<domain>    # Single domain (--limit <domain>)
#   make check                     # Dry-run (--check --diff)

- name: "Infrastructure | Reconcile Incus resources"
  hosts: all
  connection: local
  gather_facts: false
  # serial: 1  # Uncomment for strict sequential execution (prevents race conditions)
  tags:
    - infra

  tasks:
    - name: Infrastructure | Apply incus_projects
      ansible.builtin.include_role:
        name: incus_projects
        apply:
          tags:
            - projects
            - infra
      tags:
        - projects
        - infra

    - name: Infrastructure | Apply incus_networks
      ansible.builtin.include_role:
        name: incus_networks
        apply:
          tags:
            - networks
            - infra
      tags:
        - networks
        - infra

    - name: Infrastructure | Apply incus_profiles
      ansible.builtin.include_role:
        name: incus_profiles
        apply:
          tags:
            - profiles
            - infra
      tags:
        - profiles
        - infra

    - name: Infrastructure | Apply incus_instances
      ansible.builtin.include_role:
        name: incus_instances
        apply:
          tags:
            - instances
            - infra
      tags:
        - instances
        - infra
