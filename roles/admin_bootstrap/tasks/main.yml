---
# AdminBootstrap | Provisioning specific to anklume-instance
#
# Deploys the incus-socket-dir systemd service (ADR-019) so the container
# survives restarts, and ensures Ansible + git are installed.
#
# This role is applied only to hosts in the 'admin' group.

- name: AdminBootstrap | Deploy tmpfiles.d for Incus socket directory
  ansible.builtin.copy:
    src: incus-socket.conf
    dest: /etc/tmpfiles.d/incus-socket.conf
    owner: root
    group: root
    mode: "0644"

- name: AdminBootstrap | Deploy incus-socket-dir systemd service
  ansible.builtin.copy:
    src: incus-socket-dir.service
    dest: /etc/systemd/system/incus-socket-dir.service
    owner: root
    group: root
    mode: "0644"
  register: admin_bootstrap_socket_service

- name: AdminBootstrap | Enable incus-socket-dir service
  ansible.builtin.systemd:
    name: incus-socket-dir
    enabled: true
    daemon_reload: "{{ admin_bootstrap_socket_service.changed }}"

- name: AdminBootstrap | Deploy upgrade notification script
  ansible.builtin.copy:
    src: anklume-update-check.sh
    dest: /etc/profile.d/anklume-update-check.sh
    owner: root
    group: root
    mode: "0644"

- name: AdminBootstrap | Install admin packages
  ansible.builtin.apt:
    name: "{{ admin_bootstrap_packages }}"
    state: present

- name: AdminBootstrap | Ensure community.general collection
  ansible.builtin.include_tasks:
    file: roles/_shared/tasks/community-general.yml
