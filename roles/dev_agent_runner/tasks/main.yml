---
# DevAgentRunner | Setup Claude Code Agent Teams in sandbox container
#
# This role provisions a runner container (created by Phase 12's
# run-tests.sh) with Claude Code CLI and Agent Teams support.
# Runs inside the container via community.general.incus connection.

- name: DevAgentRunner | Install Node.js
  ansible.builtin.include_tasks:
    file: roles/_shared/tasks/nodejs.yml
  vars:
    _nodejs_version: "{{ dev_agent_runner_node_version }}"

- name: DevAgentRunner | Install tmux
  ansible.builtin.apt:
    name:
      - tmux
    state: present
    update_cache: true

- name: DevAgentRunner | Install Claude Code CLI
  ansible.builtin.command:
    cmd: npm install -g @anthropic-ai/claude-code
  register: dev_agent_runner_npm_install
  changed_when: "'added' in (dev_agent_runner_npm_install.stdout | default(''))"

- name: DevAgentRunner | Create Claude Code settings directory
  ansible.builtin.file:
    path: /root/.claude
    state: directory
    mode: "0700"

- name: DevAgentRunner | Deploy Claude Code settings
  ansible.builtin.template:
    src: claude-settings.json.j2
    dest: /root/.claude/settings.json
    mode: "0600"

- name: DevAgentRunner | Deploy audit hook script
  ansible.builtin.copy:
    src: agent-audit-hook.sh
    dest: /usr/local/bin/agent-audit-hook.sh
    mode: "0755"
  when: dev_agent_runner_audit_hook

- name: DevAgentRunner | Configure git identity  # noqa: command-instead-of-module
  ansible.builtin.command:
    cmd: "git config --global {{ item.key }} '{{ item.value }}'"
  loop:
    - { key: "user.name", value: "{{ dev_agent_runner_git_user }}" }
    - { key: "user.email", value: "{{ dev_agent_runner_git_email }}" }
  changed_when: true

- name: DevAgentRunner | Verify CLAUDE.md exists in project
  ansible.builtin.stat:
    path: "{{ dev_agent_runner_project_dir }}/CLAUDE.md"
  register: dev_agent_runner_claude_md

- name: DevAgentRunner | Warn if CLAUDE.md missing
  ansible.builtin.debug:
    msg: "WARNING: CLAUDE.md not found at {{ dev_agent_runner_project_dir }}/CLAUDE.md â€” clone the repo first"
  when: not dev_agent_runner_claude_md.stat.exists

# -- Egress restriction (FINDING-10) --

- name: DevAgentRunner | Install nftables for egress restriction
  ansible.builtin.apt:
    name: nftables
    state: present
  when: dev_agent_runner_restrict_egress

- name: DevAgentRunner | Deploy egress restriction rules
  ansible.builtin.copy:
    dest: /etc/nftables.d/agent-egress.nft
    mode: "0644"
    content: |
      # Agent sandbox egress restriction (FINDING-10)
      # Allow: DNS (53), HTTPS (443), loopback. Drop everything else.
      # Approved domains: {{ dev_agent_runner_allowed_domains | join(', ') }}
      # Note: nftables cannot filter by domain name; port 443 is allowed
      # to any destination. The restriction prevents non-HTTPS egress.
      table inet agent_egress {
          chain output {
              type filter hook output priority 0; policy accept;
              oifname "lo" accept
              ct state established,related accept
              udp dport 53 accept
              tcp dport 53 accept
              tcp dport 443 accept
              drop
          }
      }
  when: dev_agent_runner_restrict_egress
  notify: DevAgentRunner | Reload nftables

- name: DevAgentRunner | Enable nftables service
  ansible.builtin.systemd:
    name: nftables
    enabled: true
    state: started
  when: dev_agent_runner_restrict_egress
