#!/usr/sbin/nft -f
# anklume firewall router rules â€” generated by Ansible
# Runs INSIDE the sys-firewall VM (Phase 11)
#
# Policy: all inter-domain traffic is dropped (admin included).
# The admin container communicates via the Incus socket, not the network.
# All decisions are logged for centralized monitoring.

table inet anklume
delete table inet anklume

table inet anklume {
{% set all_ifaces = firewall_router_interfaces %}
{% set all_names = all_ifaces | map(attribute='name') | list %}

    chain forward {
        type filter hook forward priority filter; policy drop;

        # Stateful connection tracking
        ct state established,related accept
        ct state invalid{% if firewall_router_logging %} log prefix "{{ firewall_router_log_prefix }}-INVALID: "{% endif %} drop

        # Allow ICMP for diagnostics
        meta l4proto icmp accept
        meta l4proto icmpv6 accept

{% if all_names | length > 1 %}
        # Block all inter-domain forwarding (admin included)
        # Admin communicates via Incus socket, not the network
{% for iface in all_ifaces %}
{% set other_names = all_names | reject('equalto', iface.name) | list %}
{% if other_names | length > 0 %}
        iifname "{{ iface.name }}" oifname { {{ other_names | map('regex_replace', '^(.*)$', '"\\1"') | join(', ') }} }{% if firewall_router_logging %} log prefix "{{ firewall_router_log_prefix }}-DENY-{{ iface.bridge | upper | replace('NET-', '') }}: "{% endif %} drop
{% endif %}
{% endfor %}
{% endif %}

        # Default drop with logging
{% if firewall_router_logging %}
        log prefix "{{ firewall_router_log_prefix }}-DROP: " drop
{% endif %}
    }

    chain input {
        type filter hook input priority filter; policy drop;

        # Loopback
        iifname "lo" accept

        # Stateful
        ct state established,related accept

        # ICMP
        meta l4proto icmp accept
        meta l4proto icmpv6 accept

        # Default drop
{% if firewall_router_logging %}
        log prefix "{{ firewall_router_log_prefix }}-INPUT-DROP: " drop
{% endif %}
    }

    chain output {
        type filter hook output priority filter; policy accept;
    }
}
