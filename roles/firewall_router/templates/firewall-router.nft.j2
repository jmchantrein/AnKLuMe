#!/usr/sbin/nft -f
# AnKLuMe firewall router rules â€” generated by Ansible
# Runs INSIDE the sys-firewall VM (Phase 11)
#
# Policy: admin can reach all domains, non-admin domains isolated.
# All decisions are logged for centralized monitoring.

table inet anklume
delete table inet anklume

table inet anklume {
{% set admin_ifaces = firewall_router_interfaces | selectattr('is_admin', 'equalto', true) | list %}
{% set non_admin_ifaces = firewall_router_interfaces | selectattr('is_admin', 'equalto', false) | list %}
{% set admin_if = admin_ifaces[0].name if admin_ifaces | length > 0 else 'eth0' %}
{% set non_admin_names = non_admin_ifaces | map(attribute='name') | list %}

    chain forward {
        type filter hook forward priority filter; policy drop;

        # Stateful connection tracking
        ct state established,related accept
        ct state invalid{% if firewall_router_logging %} log prefix "{{ firewall_router_log_prefix }}-INVALID: "{% endif %} drop

        # Allow ICMP for diagnostics
        meta l4proto icmp accept
        meta l4proto icmpv6 accept

        # Admin domain can reach all other domains
{% if non_admin_names | length > 0 %}
        iifname "{{ admin_if }}" oifname { {{ non_admin_names | map('regex_replace', '^(.*)$', '"\\1"') | join(', ') }} }{% if firewall_router_logging %} log prefix "{{ firewall_router_log_prefix }}-ADMIN-FWD: "{% endif %} accept
{% endif %}

{% if non_admin_names | length > 1 %}
        # Block inter-domain traffic between non-admin domains
{% for iface in non_admin_ifaces %}
{% set other_names = non_admin_names | reject('equalto', iface.name) | list %}
{% if other_names | length > 0 %}
        iifname "{{ iface.name }}" oifname { {{ other_names | map('regex_replace', '^(.*)$', '"\\1"') | join(', ') }} }{% if firewall_router_logging %} log prefix "{{ firewall_router_log_prefix }}-DENY-{{ iface.bridge | upper | replace('NET-', '') }}: "{% endif %} drop
{% endif %}
{% endfor %}
{% endif %}

        # Default drop with logging
{% if firewall_router_logging %}
        log prefix "{{ firewall_router_log_prefix }}-DROP: " drop
{% endif %}
    }

    chain input {
        type filter hook input priority filter; policy drop;

        # Loopback
        iifname "lo" accept

        # Stateful
        ct state established,related accept

        # ICMP
        meta l4proto icmp accept
        meta l4proto icmpv6 accept

        # Allow SSH from admin only
        iifname "{{ admin_if }}" tcp dport 22 accept

        # Default drop
{% if firewall_router_logging %}
        log prefix "{{ firewall_router_log_prefix }}-INPUT-DROP: " drop
{% endif %}
    }

    chain output {
        type filter hook output priority filter; policy accept;
    }
}
