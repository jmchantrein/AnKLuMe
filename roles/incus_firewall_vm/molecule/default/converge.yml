---
- name: Converge - setup prerequisites
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Setup | Ensure molecule-firewall project exists
      ansible.builtin.command:
        cmd: incus project create molecule-firewall
      register: setup_project_result
      changed_when: setup_project_result.rc == 0
      failed_when: false

    - name: Setup | Configure project features
      ansible.builtin.command:
        cmd: "incus project set molecule-firewall {{ item.key }}={{ item.value }}"
      loop:
        - key: features.images
          value: "true"
        - key: features.profiles
          value: "true"
        - key: features.storage.volumes
          value: "true"
        - key: features.networks
          value: "false"
      loop_control:
        label: "{{ item.key }}={{ item.value }}"
      changed_when: false

    - name: Setup | Ensure test bridges exist
      ansible.builtin.command:
        cmd: "incus network create {{ item }}"
      loop:
        - net-mol-admin
        - net-mol-perso
      register: setup_network_result
      changed_when: setup_network_result.rc == 0
      failed_when:
        - setup_network_result.rc != 0
        - "'already exists' not in (setup_network_result.stderr | default(''))"

- name: Converge - apply incus_firewall_vm
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    incus_firewall_vm_bridge_pattern: "net-mol-"
    incus_firewall_vm_admin_bridge: "net-mol-admin"
    incus_firewall_vm_profile: "mol-firewall-multi-nic"
    incus_firewall_vm_project: "molecule-firewall"
  roles:
    - role: incus_firewall_vm
