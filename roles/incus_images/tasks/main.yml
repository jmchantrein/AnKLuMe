---
# IncusImages | Pre-download OS images to local cache
#
# Runs on the controller via connection:local (ADR-015).
# Compares needed images (incus_all_images) against local cache
# and downloads missing ones before instance creation begins.
#
# Input variables (from group_vars/all.yml, generated by PSOT):
#   - incus_all_images (list): unique OS image references (e.g. images:debian/13)

- name: IncusImages | List locally cached images
  ansible.builtin.command:
    argv:
      - incus
      - image
      - list
      - --format
      - json
  register: incus_images_cached_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusImages | Parse cached image aliases
  ansible.builtin.set_fact:
    incus_images_cached_aliases: >-
      {{ incus_images_cached_raw.stdout | from_json
         | map(attribute='aliases') | flatten
         | map(attribute='name') | list }}

- name: IncusImages | Pre-download missing images
  ansible.builtin.command:
    argv:
      - incus
      - image
      - copy
      - "{{ item }}"
      - "local:"
      - --auto-update
  loop: "{{ incus_all_images | default([]) }}"
  loop_control:
    label: "{{ item }}"
  when: "item.split(':')[-1] not in incus_images_cached_aliases"
  register: incus_images_download_result
  changed_when: incus_images_download_result is not skipped
  timeout: "{{ incus_images_download_timeout }}"

# ── Export images for nested sharing ───────────────────────────

- name: IncusImages | Create image export directory
  ansible.builtin.file:
    path: /opt/anklume/images
    state: directory
    mode: "0755"
  when: incus_images_export_for_nesting | default(false)

- name: IncusImages | Export images for nested sharing
  ansible.builtin.command:
    argv:
      - incus
      - image
      - export
      - "{{ item.split(':')[-1] }}"
      - "/opt/anklume/images/{{ item | replace(':', '_') | replace('/', '-') }}"
    creates: "/opt/anklume/images/{{ item | replace(':', '_') | replace('/', '-') }}.tar.gz"
  loop: "{{ incus_all_images | default([]) }}"
  loop_control:
    label: "{{ item }}"
  when: incus_images_export_for_nesting | default(false)
  register: incus_images_export_result
  changed_when: incus_images_export_result is not skipped and incus_images_export_result.rc == 0
