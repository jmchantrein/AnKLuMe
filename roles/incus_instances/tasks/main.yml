---
# IncusInstances | Reconcile containers and VMs
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's host_vars (PSOT-generated).
# Each host runs this role independently for its own instance;
# the reconciliation pattern (check if exists -> skip) ensures idempotence.
#
# Input variables (from host_vars, generated by PSOT):
#   - instance_name (string): instance name
#   - instance_type (string): lxc or vm
#   - instance_description (string): instance description
#   - instance_domain (string): determines the Incus project
#   - instance_os_image (string): OS image to use
#   - instance_ip (string, optional): static IP address
#   - instance_config (dict, optional): Incus config keys
#   - instance_devices (dict, optional): Incus devices (gpu, disk, etc.)
#   - instance_ephemeral (boolean): protection flag

- name: IncusInstances | Ensure images remote exists
  ansible.builtin.command:
    argv:
      - incus
      - remote
      - add
      - images
      - https://images.linuxcontainers.org
      - --protocol
      - simplestreams
      - --public
  register: incus_remote_add
  changed_when: "'exists' not in incus_remote_add.stderr"
  failed_when:
    - incus_remote_add.rc != 0
    - "'exists' not in incus_remote_add.stderr"
  run_once: true

- name: IncusInstances | List locally cached images
  ansible.builtin.command:
    argv:
      - incus
      - image
      - list
      - --format
      - json
  register: incus_instances_cached_images_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse cached image aliases
  ansible.builtin.set_fact:
    incus_instances_cached_aliases: >-
      {{ incus_instances_cached_images_raw.stdout | from_json
         | map(attribute='aliases') | flatten
         | map(attribute='name') | list }}

- name: IncusInstances | Determine if image is cached locally
  ansible.builtin.set_fact:
    incus_instances_image_cached: >-
      {{ instance_os_image.split(':')[-1] in incus_instances_cached_aliases }}

- name: IncusInstances | Set adaptive timeout for boot wait
  ansible.builtin.set_fact:
    incus_instances_effective_lxc_retries: >-
      {{ incus_instances_lxc_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_lxc_retries_with_download }}
    incus_instances_effective_vm_retries: >-
      {{ incus_instances_vm_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_vm_retries_with_download }}

- name: IncusInstances | Read existing instances in project
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse existing instance names
  ansible.builtin.set_fact:
    incus_instances_existing: >-
      {{ incus_instances_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusInstances | Launch LXC container if missing
  ansible.builtin.command:
    argv:
      - incus
      - launch
      - "{{ instance_os_image }}"
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'lxc'
  changed_when: true

- name: IncusInstances | Launch VM if missing
  ansible.builtin.command:
    argv:
      - incus
      - launch
      - "{{ instance_os_image }}"
      - "{{ instance_name }}"
      - --vm
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'vm'
  changed_when: true

- name: IncusInstances | Apply instance config keys
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "{{ item.key }}={{ item.value }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ instance_config | default({}) | dict2items }}"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"
  when: instance_config is defined and (instance_config | length > 0)
  changed_when: false

- name: IncusInstances | Check if eth0 is already overridden
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - show
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  register: incus_instance_devices_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse instance devices
  ansible.builtin.set_fact:
    incus_instance_devices: >-
      {{ incus_instance_devices_raw.stdout | from_yaml }}

- name: IncusInstances | Override eth0 from profile (first time)
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - override
      - "{{ instance_name }}"
      - eth0
      - "ipv4.address={{ instance_ip }}"
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_ip is defined and (instance_ip | length > 0)
    - "'eth0' not in (incus_instance_devices | default({}))"
  changed_when: true

- name: IncusInstances | Update eth0 IP if already overridden
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - set
      - "{{ instance_name }}"
      - eth0
      - "ipv4.address={{ instance_ip }}"
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_ip is defined and (instance_ip | length > 0)
    - "'eth0' in (incus_instance_devices | default({}))"
    - (incus_instance_devices.eth0['ipv4.address'] | default('')) != instance_ip
  changed_when: true

- name: IncusInstances | Add declared device if missing
  ansible.builtin.command:
    cmd: >-
      incus config device add
      {{ instance_name }} {{ item.key }} {{ item.value.type }}
      {% for k, v in item.value.items() if k != 'type' %}{{ k }}={{ v }} {% endfor %}
      --project {{ instance_domain }}
  loop: "{{ (instance_devices | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value.type }})"
  register: incus_device_add_result
  when:
    - instance_devices is defined and (instance_devices | length > 0)
    - item.key not in (incus_instance_devices | default({}))
  changed_when: true

- name: IncusInstances | Restart instance if devices changed
  ansible.builtin.command:
    argv:
      - incus
      - restart
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  when: incus_device_add_result is changed
  changed_when: true

- name: IncusInstances | Wait for LXC container to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_lxc_retries }}"
  delay: "{{ incus_instances_lxc_delay }}"
  when: instance_type == 'lxc'

- name: IncusInstances | Wait for VM to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_vm_retries }}"
  delay: "{{ incus_instances_vm_delay }}"
  when: instance_type == 'vm'

- name: IncusInstances | Wait for VM incus-agent to be ready
  ansible.builtin.command:
    argv:
      - incus
      - exec
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
      - --
      - "true"
  register: incus_instances_agent_check
  changed_when: false
  check_mode: false  # Safe: read-only probe
  failed_when: false
  until: incus_instances_agent_check.rc == 0
  retries: "{{ incus_instances_vm_agent_retries }}"
  delay: "{{ incus_instances_vm_agent_delay }}"
  when: instance_type == 'vm'
