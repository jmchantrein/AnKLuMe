---
# IncusInstances | Reconcile containers and VMs
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's host_vars (PSOT-generated).
# Each host runs this role independently for its own instance;
# the reconciliation pattern (check if exists -> skip) ensures idempotence.
#
# Input variables (from host_vars, generated by PSOT):
#   - instance_name (string): instance name
#   - instance_type (string): lxc or vm
#   - instance_description (string): instance description
#   - instance_domain (string): determines the Incus project
#   - instance_os_image (string): OS image to use
#   - instance_ip (string, optional): static IP address
#   - instance_config (dict, optional): Incus config keys
#   - instance_devices (dict, optional): Incus devices (gpu, disk, etc.)
#   - instance_ephemeral (boolean): protection flag
#   - instance_profiles (list, optional): Incus profiles to assign
#   - instance_storage_volumes (dict, optional): storage volumes to create/attach

- name: IncusInstances | Build profile arguments for launch
  ansible.builtin.set_fact:
    _incus_instances_profile_args: >-
      {%- set args = [] -%}
      {%- for p in (instance_profiles | default(['default'])) -%}
      {%- set _ = args.extend(['--profile', p]) -%}
      {%- endfor -%}
      {{ args }}

- name: IncusInstances | Ensure images remote exists
  ansible.builtin.command:
    argv:
      - incus
      - remote
      - add
      - images
      - https://images.linuxcontainers.org
      - --protocol
      - simplestreams
      - --public
  register: incus_remote_add
  changed_when: "'exists' not in incus_remote_add.stderr"
  failed_when:
    - incus_remote_add.rc != 0
    - "'exists' not in incus_remote_add.stderr"
  run_once: true

- name: IncusInstances | List locally cached images
  ansible.builtin.command:
    argv:
      - incus
      - image
      - list
      - --format
      - json
  register: incus_instances_cached_images_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse cached image aliases
  ansible.builtin.set_fact:
    incus_instances_cached_aliases: >-
      {{ incus_instances_cached_images_raw.stdout | from_json
         | map(attribute='aliases') | flatten
         | map(attribute='name') | list }}

- name: IncusInstances | Determine if image is cached locally
  ansible.builtin.set_fact:
    incus_instances_image_cached: >-
      {{ instance_os_image.split(':')[-1] in incus_instances_cached_aliases }}

- name: IncusInstances | Set adaptive timeout for boot wait
  ansible.builtin.set_fact:
    incus_instances_effective_lxc_retries: >-
      {{ incus_instances_lxc_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_lxc_retries_with_download }}
    incus_instances_effective_vm_retries: >-
      {{ incus_instances_vm_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_vm_retries_with_download }}

- name: IncusInstances | Read existing instances in project
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse existing instance names
  ansible.builtin.set_fact:
    incus_instances_existing: >-
      {{ incus_instances_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusInstances | Launch LXC container if missing
  ansible.builtin.command:
    argv: >-
      {{ ['incus', 'launch', instance_os_image, instance_name,
          '--project', instance_domain]
         + (_incus_instances_profile_args | from_yaml) }}
  register: incus_instances_launch_lxc_result
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'lxc'
  changed_when: incus_instances_launch_lxc_result.rc == 0
  failed_when: >-
    incus_instances_launch_lxc_result.rc != 0
    and 'already exists' not in (incus_instances_launch_lxc_result.stderr | default(''))

- name: IncusInstances | Launch VM if missing
  ansible.builtin.command:
    argv: >-
      {{ ['incus', 'launch', instance_os_image, instance_name,
          '--vm', '--project', instance_domain]
         + (_incus_instances_profile_args | from_yaml) }}
  register: incus_instances_launch_vm_result
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'vm'
  changed_when: incus_instances_launch_vm_result.rc == 0
  failed_when: >-
    incus_instances_launch_vm_result.rc != 0
    and 'already exists' not in (incus_instances_launch_vm_result.stderr | default(''))

- name: IncusInstances | Read current instance profiles
  ansible.builtin.command:
    argv:
      - incus
      - config
      - show
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  register: _incus_instances_config_raw
  changed_when: false
  check_mode: false
  when: instance_name in incus_instances_existing

- name: IncusInstances | Parse current profiles
  ansible.builtin.set_fact:
    _incus_instances_current_profiles: >-
      {{ (_incus_instances_config_raw.stdout | from_yaml).profiles | default(['default']) }}
  when: _incus_instances_config_raw is not skipped

- name: IncusInstances | Assign profiles if changed
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - assign
      - "{{ instance_name }}"
      - "{{ (instance_profiles | default(['default'])) | join(',') }}"
      - --project
      - "{{ instance_domain }}"
  when:
    - _incus_instances_current_profiles is defined
    - (_incus_instances_current_profiles | sort) != ((instance_profiles | default(['default'])) | sort)
  changed_when: true

- name: IncusInstances | Apply instance config keys
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "{{ item.key }}={{ item.value }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ instance_config | default({}) | dict2items }}"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"
  when: instance_config is defined and (instance_config | length > 0)
  changed_when: false

# ── Boot autostart (from instance_boot_autostart / instance_boot_priority) ──

- name: IncusInstances | Set boot.autostart
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "boot.autostart={{ instance_boot_autostart | lower }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_boot_autostart is defined
  changed_when: false

- name: IncusInstances | Set boot.autostart.priority
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "boot.autostart.priority={{ instance_boot_priority }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_boot_priority is defined
  changed_when: false

# ── Delete protection (from instance_ephemeral) ─────────────────────────────
# ephemeral: false → security.protection.delete=true (protected)
# ephemeral: true  → security.protection.delete=false (deletable)

- name: IncusInstances | Set security.protection.delete from ephemeral flag
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "security.protection.delete={{ 'false' if (instance_ephemeral | bool) else 'true' }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_ephemeral is defined
  changed_when: false

# ── Snapshot scheduling (from instance_snapshots_schedule / _expiry) ─────────

- name: IncusInstances | Set snapshots.schedule
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "snapshots.schedule={{ instance_snapshots_schedule }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_snapshots_schedule is defined
  changed_when: false

- name: IncusInstances | Set snapshots.expiry
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "snapshots.expiry={{ instance_snapshots_expiry }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_snapshots_expiry is defined
  changed_when: false

- name: IncusInstances | Check if eth0 is already overridden
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - show
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  register: incus_instance_devices_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse instance devices
  ansible.builtin.set_fact:
    incus_instance_devices: >-
      {{ incus_instance_devices_raw.stdout | from_yaml }}

- name: IncusInstances | Override eth0 from profile (first time)
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - override
      - "{{ instance_name }}"
      - eth0
      - "ipv4.address={{ instance_ip }}"
      - --project
      - "{{ instance_domain }}"
  register: incus_instances_eth0_override_result
  when:
    - instance_ip is defined and (instance_ip | length > 0)
    - "'eth0' not in (incus_instance_devices | default({}))"
  changed_when: true

- name: IncusInstances | Update eth0 IP if already overridden
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - set
      - "{{ instance_name }}"
      - eth0
      - "ipv4.address={{ instance_ip }}"
      - --project
      - "{{ instance_domain }}"
  register: incus_instances_eth0_update_result
  when:
    - instance_ip is defined and (instance_ip | length > 0)
    - "'eth0' in (incus_instance_devices | default({}))"
    - (incus_instance_devices.eth0['ipv4.address'] | default('')) != instance_ip
  changed_when: true

- name: IncusInstances | Add declared device if missing
  ansible.builtin.command:
    cmd: >-
      incus config device add
      {{ instance_name }} {{ item.key }} {{ item.value.type }}
      {% for k, v in item.value.items() if k != 'type' %}{{ k }}={{ v }} {% endfor %}
      --project {{ instance_domain }}
  loop: "{{ (instance_devices | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value.type }})"
  register: incus_device_add_result
  when:
    - instance_devices is defined and (instance_devices | length > 0)
    - item.key not in (incus_instance_devices | default({}))
  changed_when: true

# ── Storage volumes (from instance_storage_volumes) ──────────
# Create volumes in the Incus storage pool and attach as disk devices.

- name: IncusInstances | List existing storage volumes
  ansible.builtin.command:
    argv:
      - incus
      - storage
      - volume
      - list
      - "{{ item.value.pool | default(incus_instances_default_pool) }}"
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  loop: "{{ (instance_storage_volumes | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  register: _incus_instances_vol_list
  changed_when: false
  check_mode: false
  when: instance_storage_volumes is defined and (instance_storage_volumes | length > 0)

- name: IncusInstances | Create missing storage volumes
  ansible.builtin.command:
    argv:
      - incus
      - storage
      - volume
      - create
      - "{{ item.item.value.pool | default(incus_instances_default_pool) }}"
      - "{{ item.item.key }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ _incus_instances_vol_list.results | default([]) }}"
  loop_control:
    label: "{{ item.item.key }}"
  when:
    - item is not skipped
    - item.item.key not in (item.stdout | from_json | map(attribute='name') | list)
  changed_when: true

- name: IncusInstances | Set storage volume size
  ansible.builtin.command:
    argv:
      - incus
      - storage
      - volume
      - set
      - "{{ item.value.pool | default(incus_instances_default_pool) }}"
      - "{{ item.key }}"
      - "size={{ item.value.size }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ (instance_storage_volumes | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }} ({{ item.value.size | default('unset') }})"
  when:
    - instance_storage_volumes is defined and (instance_storage_volumes | length > 0)
    - item.value.size is defined
  changed_when: false

- name: IncusInstances | Attach storage volumes as disk devices
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - add
      - "{{ instance_name }}"
      - "{{ item.key }}"
      - disk
      - "pool={{ item.value.pool | default(incus_instances_default_pool) }}"
      - "source={{ item.key }}"
      - "path={{ item.value.path }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ (instance_storage_volumes | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }} -> {{ item.value.path | default('/mnt') }}"
  register: _incus_instances_vol_attach
  when:
    - instance_storage_volumes is defined and (instance_storage_volumes | length > 0)
    - item.value.path is defined
    - item.key not in (incus_instance_devices | default({}))
  changed_when: true

- name: IncusInstances | Restart instance if devices changed  # noqa: no-handler
  ansible.builtin.command:
    argv:
      - incus
      - restart
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  when: >-
    (incus_device_add_result is changed)
    or (_incus_instances_vol_attach is changed)
    or (incus_instances_eth0_override_result is changed)
    or (incus_instances_eth0_update_result is changed)
  changed_when: true

- name: IncusInstances | Start instance if stopped
  ansible.builtin.command:
    argv:
      - incus
      - start
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  register: _incus_instances_start_result
  when:
    - instance_name in incus_instances_existing
    - >-
      (incus_instances_raw.stdout | from_json
      | selectattr('name', 'equalto', instance_name)
      | map(attribute='status') | first | default(''))
      == 'Stopped'
  changed_when: _incus_instances_start_result.rc == 0
  failed_when: >-
    _incus_instances_start_result.rc != 0
    and 'already running' not in (_incus_instances_start_result.stderr | default(''))

- name: IncusInstances | Wait for LXC container to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_lxc_retries }}"
  delay: "{{ incus_instances_lxc_delay }}"
  when: instance_type == 'lxc'

- name: IncusInstances | Wait for VM to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_vm_retries }}"
  delay: "{{ incus_instances_vm_delay }}"
  when: instance_type == 'vm'

- name: IncusInstances | Wait for VM incus-agent to be ready
  ansible.builtin.command:
    argv:
      - incus
      - exec
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
      - --
      - "true"
  register: incus_instances_agent_check
  changed_when: false
  check_mode: false  # Safe: read-only probe
  failed_when: false
  until: incus_instances_agent_check.rc == 0
  retries: "{{ incus_instances_vm_agent_retries }}"
  delay: "{{ incus_instances_vm_agent_delay }}"
  when: instance_type == 'vm'

# ── Nesting context files (ADR-020) ──────────────────────
# Parent creates /etc/anklume/ in children with propagated context values.
# Formula: absolute_level = parent + 1
#          relative_level = 0 if VM, else parent + 1
#          vm_nested = parent_vm_nested OR (instance_type == 'vm')

- name: IncusInstances | Read parent absolute_level
  ansible.builtin.slurp:
    src: /etc/anklume/absolute_level
  register: incus_instances_parent_abs
  failed_when: false

- name: IncusInstances | Read parent relative_level
  ansible.builtin.slurp:
    src: /etc/anklume/relative_level
  register: incus_instances_parent_rel
  failed_when: false

- name: IncusInstances | Read parent vm_nested
  ansible.builtin.slurp:
    src: /etc/anklume/vm_nested
  register: incus_instances_parent_vm_nested
  failed_when: false

- name: IncusInstances | Read parent yolo
  ansible.builtin.slurp:
    src: /etc/anklume/yolo
  register: incus_instances_parent_yolo
  failed_when: false

- name: IncusInstances | Compute child nesting context
  ansible.builtin.set_fact:
    incus_instances_child_abs: >-
      {{ ((incus_instances_parent_abs.content | default('MA==') | b64decode | trim | int) + 1) | string }}
    incus_instances_child_rel: >-
      {{ '0' if instance_type == 'vm' else
         ((incus_instances_parent_rel.content | default('MA==') | b64decode | trim | int) + 1) | string }}
    incus_instances_child_vm_nested: >-
      {{ 'true' if (instance_type == 'vm') or
         ((incus_instances_parent_vm_nested.content | default('ZmFsc2U=') | b64decode | trim) == 'true')
         else 'false' }}
    incus_instances_child_yolo: >-
      {{ incus_instances_parent_yolo.content | default('ZmFsc2U=') | b64decode | trim }}
  when: incus_instances_parent_abs is defined

- name: IncusInstances | Create /etc/anklume in child instance
  ansible.builtin.command:
    argv:
      - incus
      - exec
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
      - --
      - mkdir
      - -p
      - /etc/anklume
  changed_when: false
  when: incus_instances_child_abs is defined

- name: IncusInstances | Write child context files
  ansible.builtin.command:
    cmd: >-
      incus exec {{ instance_name }} --project {{ instance_domain }}
      -- bash -c 'echo "{{ item.value }}" > /etc/anklume/{{ item.key }}'
  loop:
    - { key: "absolute_level", value: "{{ incus_instances_child_abs | trim }}" }
    - { key: "relative_level", value: "{{ incus_instances_child_rel | trim }}" }
    - { key: "vm_nested", value: "{{ incus_instances_child_vm_nested | trim }}" }
    - { key: "yolo", value: "{{ incus_instances_child_yolo | trim }}" }
  loop_control:
    label: "{{ item.key }}={{ item.value | trim }}"
  changed_when: false
  when: incus_instances_child_abs is defined
