---
# IncusInstances | Reconcile containers and VMs
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's host_vars (PSOT-generated).
# Each host runs this role independently for its own instance;
# the reconciliation pattern (check if exists â†’ skip) ensures idempotence.
#
# Input variables (from host_vars, generated by PSOT):
#   - instance_name (string): instance name
#   - instance_type (string): lxc or vm
#   - instance_description (string): instance description
#   - instance_domain (string): determines the Incus project
#   - instance_os_image (string): OS image to use
#   - instance_ip (string, optional): static IP address
#   - instance_config (dict, optional): Incus config keys
#   - instance_ephemeral (boolean): protection flag

- name: IncusInstances | Read existing instances in project
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse existing instance names
  ansible.builtin.set_fact:
    incus_instances_existing: >-
      {{ incus_instances_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusInstances | Launch LXC container if missing
  ansible.builtin.command:
    argv:
      - incus
      - launch
      - "{{ instance_os_image }}"
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'lxc'
  changed_when: true

- name: IncusInstances | Launch VM if missing
  ansible.builtin.command:
    argv:
      - incus
      - launch
      - "{{ instance_os_image }}"
      - "{{ instance_name }}"
      - --vm
      - --project
      - "{{ instance_domain }}"
  when:
    - instance_name not in incus_instances_existing
    - instance_type == 'vm'
  changed_when: true

- name: IncusInstances | Apply instance config keys
  ansible.builtin.command:
    argv:
      - incus
      - config
      - set
      - "{{ instance_name }}"
      - "{{ item.key }}={{ item.value }}"
      - --project
      - "{{ instance_domain }}"
  loop: "{{ instance_config | default({}) | dict2items }}"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"
  when: instance_config is defined and instance_config
  changed_when: false

- name: IncusInstances | Set static IP via device override
  ansible.builtin.command:
    argv:
      - incus
      - config
      - device
      - set
      - "{{ instance_name }}"
      - eth0
      - "ipv4.address={{ instance_ip }}"
      - --project
      - "{{ instance_domain }}"
  when: instance_ip is defined and instance_ip
  changed_when: false

- name: IncusInstances | Wait for instance to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: 30
  delay: 2
