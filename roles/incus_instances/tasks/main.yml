---
# IncusInstances | Reconcile containers and VMs
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's host_vars (PSOT-generated).
# Each host runs this role independently for its own instance;
# the reconciliation pattern (check if exists -> skip) ensures idempotence.
#
# Input variables (from host_vars, generated by PSOT):
#   - instance_name (string): instance name
#   - instance_type (string): lxc or vm
#   - instance_description (string): instance description
#   - instance_domain (string): determines the Incus project
#   - instance_os_image (string): OS image to use
#   - instance_ip (string, optional): static IP address
#   - instance_config (dict, optional): Incus config keys
#   - instance_devices (dict, optional): Incus devices (gpu, disk, etc.)
#   - instance_ephemeral (boolean): protection flag
#   - instance_profiles (list, optional): Incus profiles to assign
#   - instance_storage_volumes (dict, optional): storage volumes to create/attach
#
# Sub-tasks (included below):
#   - launch.yml: Instance creation (LXC and VM)
#   - config.yml: Config reconciliation (profiles, config keys, boot, ephemeral, snapshots)
#   - devices.yml: Network/device management and storage volumes
#   - start_wait.yml: Instance restart/start/wait logic
#   - nesting_context.yml: Nesting context propagation (ADR-020)

- name: IncusInstances | Build profile arguments for launch
  ansible.builtin.set_fact:
    _incus_instances_profile_args: >-
      {%- set args = [] -%}
      {%- for p in (instance_profiles | default(['default'])) -%}
      {%- set _ = args.extend(['--profile', p]) -%}
      {%- endfor -%}
      {{ args }}

- name: IncusInstances | Ensure images remote exists
  ansible.builtin.command:
    argv:
      - incus
      - remote
      - add
      - images
      - https://images.linuxcontainers.org
      - --protocol
      - simplestreams
      - --public
  register: incus_remote_add
  changed_when: "'exists' not in incus_remote_add.stderr"
  failed_when:
    - incus_remote_add.rc != 0
    - "'exists' not in incus_remote_add.stderr"
  run_once: true

- name: IncusInstances | List locally cached images
  ansible.builtin.command:
    argv:
      - incus
      - image
      - list
      - --format
      - json
  register: incus_instances_cached_images_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse cached image aliases
  ansible.builtin.set_fact:
    incus_instances_cached_aliases: >-
      {{ incus_instances_cached_images_raw.stdout | from_json
         | map(attribute='aliases') | flatten
         | map(attribute='name') | list }}

- name: IncusInstances | Determine if image is cached locally
  ansible.builtin.set_fact:
    incus_instances_image_cached: >-
      {{ instance_os_image.split(':')[-1] in incus_instances_cached_aliases }}

- name: IncusInstances | Set adaptive timeout for boot wait
  ansible.builtin.set_fact:
    incus_instances_effective_lxc_retries: >-
      {{ incus_instances_lxc_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_lxc_retries_with_download }}
    incus_instances_effective_vm_retries: >-
      {{ incus_instances_vm_retries
         if (incus_instances_image_cached | bool)
         else incus_instances_vm_retries_with_download }}

- name: IncusInstances | Read existing instances in project
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusInstances | Parse existing instance names
  ansible.builtin.set_fact:
    incus_instances_existing: >-
      {{ incus_instances_raw.stdout | from_json | map(attribute='name') | list }}

# -- Sub-tasks --

- name: IncusInstances | Launch instances
  ansible.builtin.include_tasks: launch.yml

- name: IncusInstances | Reconcile config
  ansible.builtin.include_tasks: config.yml

- name: IncusInstances | Reconcile devices
  ansible.builtin.include_tasks: devices.yml

- name: IncusInstances | Start and wait
  ansible.builtin.include_tasks: start_wait.yml

- name: IncusInstances | Propagate nesting context
  ansible.builtin.include_tasks: nesting_context.yml
