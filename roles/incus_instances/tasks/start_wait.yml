---
# IncusInstances | Instance restart, start, and wait logic
#
# Included from main.yml after devices.yml.
# Restarts if devices changed, starts if stopped, waits for
# LXC/VM to be running and VM agent to be ready.
#
# Requires: instance_name, instance_type, instance_domain,
#           incus_instances_existing, incus_instances_raw,
#           incus_instances_effective_lxc_retries,
#           incus_instances_effective_vm_retries,
#           incus_device_add_result, _incus_instances_vol_attach,
#           incus_instances_eth0_override_result,
#           incus_instances_eth0_update_result

- name: IncusInstances | Restart instance if devices changed  # noqa: no-handler
  ansible.builtin.command:
    argv:
      - incus
      - restart
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  when: >-
    (incus_device_add_result is changed)
    or (_incus_instances_vol_attach is changed)
    or (incus_instances_eth0_override_result is changed)
    or (incus_instances_eth0_update_result is changed)
  changed_when: true

- name: IncusInstances | Start instance if stopped
  ansible.builtin.command:
    argv:
      - incus
      - start
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
  register: _incus_instances_start_result
  when:
    - instance_name in incus_instances_existing
    - >-
      (incus_instances_raw.stdout | from_json
      | selectattr('name', 'equalto', instance_name)
      | map(attribute='status') | first | default(''))
      == 'Stopped'
  changed_when: _incus_instances_start_result.rc == 0
  failed_when: >-
    _incus_instances_start_result.rc != 0
    and 'already running' not in (_incus_instances_start_result.stderr | default(''))

- name: IncusInstances | Wait for LXC container to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_lxc_retries }}"
  delay: "{{ incus_instances_lxc_delay }}"
  when: instance_type == 'lxc'

- name: IncusInstances | Wait for VM to be running
  ansible.builtin.command:
    argv:
      - incus
      - list
      - --project
      - "{{ instance_domain }}"
      - --format
      - json
  register: incus_instances_status_raw
  changed_when: false
  check_mode: false  # Safe: read-only command
  until: >-
    (incus_instances_status_raw.stdout | from_json
    | selectattr('name', 'equalto', instance_name)
    | map(attribute='status') | first | default(''))
    == 'Running'
  retries: "{{ incus_instances_effective_vm_retries }}"
  delay: "{{ incus_instances_vm_delay }}"
  when: instance_type == 'vm'

- name: IncusInstances | Wait for VM incus-agent to be ready
  ansible.builtin.command:
    argv:
      - incus
      - exec
      - "{{ instance_name }}"
      - --project
      - "{{ instance_domain }}"
      - --
      - "true"
  register: incus_instances_agent_check
  changed_when: false
  check_mode: false  # Safe: read-only probe
  failed_when: false
  until: incus_instances_agent_check.rc == 0
  retries: "{{ incus_instances_vm_agent_retries }}"
  delay: "{{ incus_instances_vm_agent_delay }}"
  when: instance_type == 'vm'
