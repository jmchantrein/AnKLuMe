---
# IncusNetworks | Reconcile domain bridges
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's group_vars/host_vars (PSOT-generated).
# Multiple hosts may share the same domain — the reconciliation pattern
# (check if exists → create if missing) ensures idempotence.
#
# Networks are global resources in Incus. When projects use
# features.networks=false (our default), networks live in the default
# project and are shared across all projects. Network commands do NOT
# take --project.
# Reference: https://linuxcontainers.org/incus/docs/main/explanation/projects/
#
# Input variables (from group_vars, generated by PSOT):
#   - incus_network.name (string): bridge name (e.g. net-admin)
#   - incus_network.subnet (string): e.g. 10.100.0.0/24
#   - incus_network.gateway (string): e.g. 10.100.0.254
#   - domain_ephemeral (boolean): protection flag

- name: IncusNetworks | Read existing networks
  ansible.builtin.command:
    cmd: incus network list --format json
  register: incus_networks_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusNetworks | Parse existing network names
  ansible.builtin.set_fact:
    incus_networks_existing: >-
      {{ incus_networks_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusNetworks | Create network if missing
  ansible.builtin.command:
    argv:
      - incus
      - network
      - create
      - "{{ incus_network.name }}"
  register: incus_networks_create_result
  when: incus_network.name not in incus_networks_existing
  changed_when: incus_networks_create_result.rc == 0
  failed_when: >-
    incus_networks_create_result.rc != 0
    and 'UNIQUE constraint failed' not in (incus_networks_create_result.stderr | default(''))
    and 'already exists' not in (incus_networks_create_result.stderr | default(''))

- name: IncusNetworks | Read network config
  ansible.builtin.command:
    argv:
      - incus
      - network
      - show
      - "{{ incus_network.name }}"
  register: incus_networks_show_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusNetworks | Parse network config
  ansible.builtin.set_fact:
    incus_networks_current_config: >-
      {{ (incus_networks_show_raw.stdout | from_yaml).config | default({}) }}

- name: IncusNetworks | Build DHCP range from gateway
  ansible.builtin.set_fact:
    incus_networks_dhcp_range: >-
      {{ incus_network.gateway | regex_replace('\.254$', '.100') }}-{{
         incus_network.gateway | regex_replace('\.254$', '.249') }}

- name: IncusNetworks | Build desired config
  ansible.builtin.set_fact:
    incus_networks_desired_config:
      ipv4.address: "{{ incus_network.gateway }}/24"
      ipv4.nat: "true"
      ipv4.firewall: "true"
      ipv4.dhcp.ranges: "{{ incus_networks_dhcp_range }}"
      ipv6.address: none

- name: IncusNetworks | Set network config
  ansible.builtin.command:
    argv:
      - incus
      - network
      - set
      - "{{ incus_network.name }}"
      - "{{ item.key }}={{ item.value }}"
  loop: "{{ incus_networks_desired_config | dict2items }}"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"
  when: >-
    incus_networks_current_config[item.key] | default('') | string
    != item.value | string
  changed_when: true
