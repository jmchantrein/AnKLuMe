#!/usr/sbin/nft -f
# AnKLuMe inter-bridge isolation rules
# Generated by incus_nftables role — do not edit manually
# Re-generate with: make nftables

# Atomic replace: create empty → delete → recreate with rules
table inet anklume;
delete table inet anklume;

table inet anklume {
    chain isolation {
        type filter hook forward priority -1; policy accept;

        # Stateful: allow return traffic
        ct state established,related accept
        ct state invalid drop

        # Same-bridge: accept (br_netfilter compatibility)
{% for bridge in incus_nftables_all_bridges %}
        iifname "{{ bridge }}" oifname "{{ bridge }}" accept
{% endfor %}

        # Admin bridge: allow outbound to all other bridges
        iifname "{{ incus_nftables_admin_bridge }}" accept

{% if incus_nftables_non_admin_bridges | length > 1 %}
        # Non-admin inter-bridge forwarding: drop
        iifname { {{ incus_nftables_non_admin_bridges | map('regex_replace', '^(.*)$', '"\\1"') | join(', ') }} } oifname { {{ incus_nftables_non_admin_bridges | map('regex_replace', '^(.*)$', '"\\1"') | join(', ') }} } drop
{% endif %}
    }
}
