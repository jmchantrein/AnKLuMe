---
# IncusProfiles | Reconcile the default profile in each project
#
# Each project's default profile is configured with:
#   - eth0: nic device attached to the domain's bridge
#   - root: disk device with pool=default
#
# Profile commands require --project to target the correct project.
# Networks are global (ADR-014), but profiles are project-scoped.
#
# Input variables (from group_vars, generated by PSOT):
#   - incus_project (string): project name
#   - incus_network.name (string): bridge name (e.g. net-admin)

- name: IncusProfiles | Read current default profile
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - show
      - default
      - --project
      - "{{ incus_project }}"
  register: incus_profiles_show_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProfiles | Parse current profile devices
  ansible.builtin.set_fact:
    incus_profiles_current_devices: >-
      {{ (incus_profiles_show_raw.stdout | from_yaml).devices | default({}) }}

- name: IncusProfiles | Add eth0 device if missing
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - add
      - default
      - eth0
      - nic
      - "network={{ incus_network.name }}"
      - name=eth0
      - --project
      - "{{ incus_project }}"
  when: "'eth0' not in incus_profiles_current_devices"
  changed_when: true

- name: IncusProfiles | Update eth0 network if wrong
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - set
      - default
      - eth0
      - "network={{ incus_network.name }}"
      - --project
      - "{{ incus_project }}"
  when:
    - "'eth0' in incus_profiles_current_devices"
    - "incus_profiles_current_devices['eth0']['network'] | default('') != incus_network.name"
  changed_when: true

- name: IncusProfiles | Add root device if missing
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - add
      - default
      - root
      - disk
      - pool=default
      - path=/
      - --project
      - "{{ incus_project }}"
  when: "'root' not in incus_profiles_current_devices"
  changed_when: true

- name: IncusProfiles | Update root device if wrong
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - set
      - default
      - root
      - pool=default
      - path=/
      - --project
      - "{{ incus_project }}"
  when:
    - "'root' in incus_profiles_current_devices"
    - >-
      incus_profiles_current_devices['root']['pool'] | default('') != 'default'
      or incus_profiles_current_devices['root']['path'] | default('') != '/'
  changed_when: true
