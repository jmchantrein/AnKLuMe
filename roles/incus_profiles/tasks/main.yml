---
# IncusProfiles | Reconcile default + custom profiles in each project
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's group_vars/host_vars (PSOT-generated).
# Multiple hosts may share the same domain — the reconciliation pattern
# (check if exists → create if missing) ensures idempotence.
#
# Each project's default profile is configured with:
#   - eth0: nic device attached to the domain's bridge
#   - root: disk device with pool=default
#
# Custom profiles from incus_profiles (defined in infra.yml domains.*.profiles)
# are created with their declared devices and config.
#
# Profile commands require --project to target the correct project.
# Networks are global (ADR-014), but profiles are project-scoped.
#
# Input variables (from group_vars, generated by PSOT):
#   - incus_project (string): project name
#   - incus_network.name (string): bridge name (e.g. net-admin)
#   - incus_profiles (dict, optional): custom profiles to create

- name: IncusProfiles | Read current default profile
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - show
      - default
      - --project
      - "{{ incus_project }}"
  register: incus_profiles_show_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProfiles | Parse current profile devices
  ansible.builtin.set_fact:
    incus_profiles_current_devices: >-
      {{ (incus_profiles_show_raw.stdout | from_yaml).devices | default({}) }}

- name: IncusProfiles | Add eth0 device if missing
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - add
      - default
      - eth0
      - nic
      - "network={{ incus_network.name }}"
      - name=eth0
      - --project
      - "{{ incus_project }}"
  register: incus_profiles_add_eth0_result
  when: "'eth0' not in incus_profiles_current_devices"
  changed_when: incus_profiles_add_eth0_result.rc == 0
  failed_when: >-
    incus_profiles_add_eth0_result.rc != 0
    and 'already exists' not in (incus_profiles_add_eth0_result.stderr | default(''))

- name: IncusProfiles | Update eth0 network if wrong
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - set
      - default
      - eth0
      - "network={{ incus_network.name }}"
      - --project
      - "{{ incus_project }}"
  when:
    - "'eth0' in incus_profiles_current_devices"
    - "incus_profiles_current_devices['eth0']['network'] | default('') != incus_network.name"
  changed_when: true

- name: IncusProfiles | Add root device if missing
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - add
      - default
      - root
      - disk
      - pool=default
      - path=/
      - --project
      - "{{ incus_project }}"
  register: incus_profiles_add_root_result
  when: "'root' not in incus_profiles_current_devices"
  changed_when: incus_profiles_add_root_result.rc == 0
  failed_when: >-
    incus_profiles_add_root_result.rc != 0
    and 'already exists' not in (incus_profiles_add_root_result.stderr | default(''))

- name: IncusProfiles | Update root device if wrong
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - set
      - default
      - root
      - pool=default
      - path=/
      - --project
      - "{{ incus_project }}"
  when:
    - "'root' in incus_profiles_current_devices"
    - >-
      incus_profiles_current_devices['root']['pool'] | default('') != 'default'
      or incus_profiles_current_devices['root']['path'] | default('') != '/'
  changed_when: true

# ── Custom profiles (from incus_profiles in group_vars) ────────

- name: IncusProfiles | List existing profiles in project
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - list
      - --project
      - "{{ incus_project }}"
      - --format
      - json
  register: incus_profiles_list_raw
  changed_when: false
  check_mode: false
  when: incus_profiles is defined and (incus_profiles | length > 0)

- name: IncusProfiles | Parse existing profile names
  ansible.builtin.set_fact:
    incus_profiles_existing_names: >-
      {{ incus_profiles_list_raw.stdout | from_json | map(attribute='name') | list }}
  when: incus_profiles_list_raw is not skipped

- name: IncusProfiles | Create custom profiles if missing
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - create
      - "{{ item.key }}"
      - --project
      - "{{ incus_project }}"
  loop: "{{ (incus_profiles | default({})) | dict2items }}"
  loop_control:
    label: "{{ item.key }}"
  register: incus_profiles_create_result
  when:
    - incus_profiles_existing_names is defined
    - item.key not in incus_profiles_existing_names
  changed_when: incus_profiles_create_result.rc == 0
  failed_when: >-
    incus_profiles_create_result.rc != 0
    and 'already exists' not in (incus_profiles_create_result.stderr | default(''))

- name: IncusProfiles | Flatten device entries
  ansible.builtin.set_fact:
    incus_profiles_flat_devices: >-
      {% set result = [] -%}
      {% for prof_name, prof in (incus_profiles | default({})).items() -%}
      {% for dev_name, dev in (prof.devices | default({})).items() -%}
      {% set _ = result.append({'profile': prof_name, 'device': dev_name, 'config': dev}) -%}
      {% endfor -%}
      {% endfor -%}
      {{ result }}
  when: incus_profiles is defined and (incus_profiles | length > 0)

- name: IncusProfiles | Add devices to custom profiles
  ansible.builtin.command:
    cmd: >-
      incus profile device add {{ item.profile }} {{ item.device }} {{ item.config.type }}
      {% for k, v in item.config.items() if k != 'type' %}{{ k }}={{ v }} {% endfor %}
      --project {{ incus_project }}
  loop: "{{ incus_profiles_flat_devices | default([]) }}"
  loop_control:
    label: "{{ item.profile }}/{{ item.device }}"
  register: incus_profiles_device_add_result
  changed_when: incus_profiles_device_add_result.rc == 0
  failed_when: >-
    incus_profiles_device_add_result.rc != 0
    and 'already exists' not in (incus_profiles_device_add_result.stderr | default(''))
