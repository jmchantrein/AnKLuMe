---
- name: Verify incus_projects
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Verify | Read project list
      ansible.builtin.command:
        cmd: incus project list --format json
      register: verify_projects_raw
      changed_when: false

    - name: Verify | Parse project list
      ansible.builtin.set_fact:
        verify_projects: "{{ verify_projects_raw.stdout | from_json }}"

    - name: Verify | Project exists
      ansible.builtin.assert:
        that:
          - "'molecule-test' in (verify_projects | map(attribute='name') | list)"
        fail_msg: "Project molecule-test does not exist"

    - name: Verify | Read project config
      ansible.builtin.command:
        cmd: incus project show molecule-test
      register: verify_project_show_raw
      changed_when: false

    - name: Verify | Parse project config
      ansible.builtin.set_fact:
        verify_project: "{{ verify_project_show_raw.stdout | from_yaml }}"

    - name: Verify | Project has correct features
      ansible.builtin.assert:
        that:
          - "verify_project.config['features.images'] == 'true'"
          - "verify_project.config['features.profiles'] == 'true'"
          - "verify_project.config['features.storage.volumes'] == 'true'"
          - "verify_project.config['features.networks'] == 'false'"
        fail_msg: "Project features are incorrect"

    - name: Verify | Project description matches
      ansible.builtin.assert:
        that:
          - "verify_project.description == 'Molecule test project'"
        fail_msg: "Project description does not match"

    - name: Verify | Read default profile
      ansible.builtin.command:
        argv:
          - incus
          - profile
          - show
          - default
          - --project
          - molecule-test
      register: verify_profile_raw
      changed_when: false

    - name: Verify | Parse default profile
      ansible.builtin.set_fact:
        verify_profile: "{{ verify_profile_raw.stdout | from_yaml }}"

    - name: Verify | NIC security MAC filtering enabled
      ansible.builtin.assert:
        that:
          - "verify_profile.devices.eth0['security.mac_filtering'] == 'true'"
        fail_msg: "security.mac_filtering not set on eth0"

    - name: Verify | NIC security IPv4 filtering enabled
      ansible.builtin.assert:
        that:
          - "verify_profile.devices.eth0['security.ipv4_filtering'] == 'true'"
        fail_msg: "security.ipv4_filtering not set on eth0"

    - name: Verify | NIC security IPv6 filtering enabled
      ansible.builtin.assert:
        that:
          - "verify_profile.devices.eth0['security.ipv6_filtering'] == 'true'"
        fail_msg: "security.ipv6_filtering not set on eth0"

    - name: Verify | Idempotency - run role again
      ansible.builtin.include_role:
        name: incus_projects
      vars:
        incus_project: molecule-test
        domain_description: "Molecule test project"
        domain_ephemeral: true
      register: idempotency_result

    - name: Verify | Idempotency - check no changes
      ansible.builtin.assert:
        that:
          - not (idempotency_result is changed)
        fail_msg: "Role is not idempotent â€” second run produced changes"
