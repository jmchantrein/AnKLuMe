---
# IncusProjects | Reconcile Incus projects for each domain
#
# Input variables (from group_vars, generated by PSOT):
#   - incus_project (string): project name
#   - domain_description (string): project description
#   - domain_ephemeral (boolean): protection flag

- name: IncusProjects | Read existing projects
  ansible.builtin.command:
    cmd: incus project list --format json
  register: incus_projects_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProjects | Parse existing project names
  ansible.builtin.set_fact:
    incus_projects_existing: >-
      {{ incus_projects_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusProjects | Create project if missing
  ansible.builtin.command:
    argv:
      - incus
      - project
      - create
      - "{{ incus_project }}"
  when: incus_project not in incus_projects_existing
  changed_when: true

- name: IncusProjects | Configure project features
  ansible.builtin.command:
    argv:
      - incus
      - project
      - set
      - "{{ incus_project }}"
      - "features.images=true"
      - "features.profiles=true"
      - "features.storage.volumes=true"
      - "features.networks=false"
  changed_when: false

- name: IncusProjects | Read project config
  ansible.builtin.command:
    argv:
      - incus
      - project
      - show
      - "{{ incus_project }}"
  register: incus_projects_show_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProjects | Set project description if needed
  ansible.builtin.command:
    argv:
      - incus
      - project
      - set
      - "{{ incus_project }}"
      - "description={{ domain_description }}"
  when: >-
    (incus_projects_show_raw.stdout | from_yaml).description | default('')
    != domain_description
  changed_when: true
