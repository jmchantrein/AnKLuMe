---
# IncusProjects | Reconcile Incus projects for each domain
#
# Runs on the controller via connection:local (ADR-015).
# Variables come from each host's group_vars/host_vars (PSOT-generated).
# Multiple hosts may share the same domain — the reconciliation pattern
# (check if exists → create if missing) ensures idempotence.
#
# Input variables (from group_vars, generated by PSOT):
#   - incus_project (string): project name
#   - domain_description (string): project description
#   - domain_ephemeral (boolean): protection flag

- name: IncusProjects | Read existing projects
  ansible.builtin.command:
    cmd: incus project list --format json
  register: incus_projects_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProjects | Parse existing project names
  ansible.builtin.set_fact:
    incus_projects_existing: >-
      {{ incus_projects_raw.stdout | from_json | map(attribute='name') | list }}

- name: IncusProjects | Create project if missing
  ansible.builtin.command:
    argv:
      - incus
      - project
      - create
      - "{{ incus_project }}"
  register: incus_projects_create_result
  when: incus_project not in incus_projects_existing
  changed_when: incus_projects_create_result.rc == 0
  failed_when: >-
    incus_projects_create_result.rc != 0
    and 'UNIQUE constraint failed' not in (incus_projects_create_result.stderr | default(''))
    and 'already exists' not in (incus_projects_create_result.stderr | default(''))

- name: IncusProjects | Read project config
  ansible.builtin.command:
    argv:
      - incus
      - project
      - show
      - "{{ incus_project }}"
  register: incus_projects_show_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProjects | Parse current project config
  ansible.builtin.set_fact:
    _incus_projects_current_config: >-
      {{ (incus_projects_show_raw.stdout | from_yaml).config | default({}) }}

- name: IncusProjects | Configure project features
  ansible.builtin.command:
    argv:
      - incus
      - project
      - set
      - "{{ incus_project }}"
      - "features.images=true"
      - "features.profiles=true"
      - "features.storage.volumes=true"
      - "features.networks=false"
  when: >-
    (_incus_projects_current_config['features.images'] | default('')) != 'true'
    or (_incus_projects_current_config['features.profiles'] | default('')) != 'true'
    or (_incus_projects_current_config['features.storage.volumes'] | default('')) != 'true'
    or (_incus_projects_current_config['features.networks'] | default('')) != 'false'
  changed_when: true

- name: IncusProjects | Set project description if needed
  ansible.builtin.command:
    argv:
      - incus
      - project
      - set
      - "{{ incus_project }}"
      - "description={{ domain_description }}"
      - --property
  register: incus_projects_desc_result
  when: >-
    (incus_projects_show_raw.stdout | from_yaml).description | default('')
    != domain_description
  changed_when: incus_projects_desc_result.rc == 0
  failed_when: >-
    incus_projects_desc_result.rc != 0
    and 'ETag' not in (incus_projects_desc_result.stderr | default(''))

# ── NIC security filtering on default profile eth0 ──────────

- name: IncusProjects | Read default profile for NIC filtering
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - show
      - default
      - --project
      - "{{ incus_project }}"
  register: incus_projects_profile_raw
  changed_when: false
  check_mode: false  # Safe: read-only command

- name: IncusProjects | Parse default profile devices
  ansible.builtin.set_fact:
    incus_projects_profile_devices: >-
      {{ (incus_projects_profile_raw.stdout | from_yaml).devices | default({}) }}

- name: IncusProjects | Configure NIC security filtering on eth0
  ansible.builtin.command:
    argv:
      - incus
      - profile
      - device
      - set
      - default
      - eth0
      - "{{ item.key }}={{ item.value }}"
      - --project
      - "{{ incus_project }}"
  loop:
    - key: security.mac_filtering
      value: "true"
    - key: security.ipv4_filtering
      value: "true"
    - key: security.ipv6_filtering
      value: "true"
  loop_control:
    label: "{{ item.key }}={{ item.value }}"
  when:
    - "'eth0' in incus_projects_profile_devices"
    - >-
      incus_projects_profile_devices['eth0'][item.key] | default('')
      != item.value
  changed_when: true
