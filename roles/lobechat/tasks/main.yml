---
# LobeChat | Install and configure LobeChat web UI
#
# Applied via the provisioning play (connection: community.general.incus).
# Runs INSIDE the target container.
#
# Input variables (from defaults, overridable in host_vars):
#   - lobechat_port (int): port to listen on
#   - lobechat_ollama_url (string): URL of the Ollama API server
#   - lobechat_node_version (int): Node.js major version
#   - lobechat_version (string): git branch or tag to deploy

- name: LobeChat | Install Node.js repository
  ansible.builtin.shell:
    cmd: >-
      curl -fsSL https://deb.nodesource.com/setup_{{ lobechat_node_version }}.x
      | bash -
    creates: /etc/apt/sources.list.d/nodesource.list

- name: LobeChat | Install system dependencies
  ansible.builtin.apt:
    name:
      - nodejs
      - git
    state: present
    update_cache: true

- name: LobeChat | Install pnpm
  ansible.builtin.command:
    cmd: npm install -g pnpm
    creates: /usr/bin/pnpm

- name: LobeChat | Clone LobeChat repository
  ansible.builtin.git:
    repo: https://github.com/lobehub/lobe-chat.git
    dest: /opt/lobechat
    version: "{{ lobechat_version }}"
    depth: 1
  register: lobechat_git_clone

- name: LobeChat | Install dependencies
  ansible.builtin.command:
    cmd: pnpm install --frozen-lockfile
    chdir: /opt/lobechat
  when: lobechat_git_clone is changed
  changed_when: true

- name: LobeChat | Build application
  ansible.builtin.command:
    cmd: pnpm build
    chdir: /opt/lobechat
  environment:
    NODE_OPTIONS: "--max-old-space-size=8192"
  when: lobechat_git_clone is changed
  changed_when: true

- name: LobeChat | Deploy systemd service
  ansible.builtin.template:
    src: lobechat.service.j2
    dest: /etc/systemd/system/lobechat.service
    mode: "0644"
  notify: LobeChat | Restart LobeChat

- name: LobeChat | Enable and start LobeChat service
  ansible.builtin.systemd:
    name: lobechat
    enabled: "{{ lobechat_service_enabled }}"
    state: started
    daemon_reload: true
