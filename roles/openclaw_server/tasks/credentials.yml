---
# OpenclawServer | Git identity, credentials, and FINDING-03 checks

- name: OpenclawServer | Configure git identity
  community.general.git_config:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { key: "user.name", value: "{{ openclaw_server_agent_name }}" }
    - { key: "user.email", value: "{{ openclaw_server_agent_name | lower }}@anklume.local" }

- name: OpenclawServer | Check for mounted secrets
  ansible.builtin.stat:
    path: /run/secrets/git-credentials
  register: _openclaw_git_creds

- name: OpenclawServer | Configure git credential helper
  community.general.git_config:
    name: credential.helper
    value: "store --file /run/secrets/git-credentials"
    scope: global
  when: _openclaw_git_creds.stat.exists

- name: OpenclawServer | Check credential file permissions (FINDING-03)
  ansible.builtin.command:
    cmd: stat -c '%a' /run/secrets/git-credentials
  register: _openclaw_cred_perms
  changed_when: false
  failed_when: false
  when: _openclaw_git_creds.stat.exists

- name: OpenclawServer | Warn if credentials too permissive (FINDING-03)
  ansible.builtin.debug:
    msg: >-
      SECURITY WARNING: /run/secrets/git-credentials has mode
      {{ _openclaw_cred_perms.stdout }}. Host file should be 0600 with
      raw.idmap mapping (host UID {{ openclaw_server_credential_host_uid }}
      -> container root). See docs/security-audit-operational.md FINDING-03.
  when:
    - _openclaw_git_creds.stat.exists
    - _openclaw_cred_perms.rc == 0
    - _openclaw_cred_perms.stdout != "600"

- name: OpenclawServer | Warn if no git credentials mounted
  ansible.builtin.debug:
    msg: >-
      No GitHub credentials found at /run/secrets/git-credentials.
      {{ openclaw_server_agent_name }} cannot push to GitHub. Fix: create
      ~/.anklume/secrets/git-credentials on the host (mode 0600) and add
      a disk device with raw.idmap mapping. See FINDING-03.
  when: not _openclaw_git_creds.stat.exists
