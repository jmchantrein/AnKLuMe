---
# OpenclawServer | Install and configure OpenClaw AI assistant
#
# Applied via the provisioning play (connection: community.general.incus).
# Runs INSIDE the target container.
#
# OpenClaw is a self-hosted AI assistant that connects to messaging
# platforms and drives local/remote LLMs via its gateway daemon.
#
# Input variables (from defaults, overridable in host_vars):
#   - openclaw_server_ollama_url (string): Ollama API base URL
#   - openclaw_server_ollama_api_key (string): Ollama API key (any value)
#   - openclaw_server_enabled (bool): enable systemd service

- name: OpenclawServer | Install curl for nodesource setup
  ansible.builtin.apt:
    name: curl
    state: present
    update_cache: true

- name: OpenclawServer | Install Node.js repository  # noqa: command-instead-of-module risky-shell-pipe
  ansible.builtin.shell:
    cmd: curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    creates: /etc/apt/sources.list.d/nodesource.list

- name: OpenclawServer | Install system dependencies
  ansible.builtin.apt:
    name:
      - nodejs
      - git
    state: latest
    update_cache: true

- name: OpenclawServer | Install OpenClaw
  ansible.builtin.command:
    cmd: npm install -g openclaw@latest
    creates: /usr/bin/openclaw
  changed_when: false

- name: OpenclawServer | Create data directory
  ansible.builtin.file:
    path: /root/.openclaw
    state: directory
    mode: "0755"

- name: OpenclawServer | Configure Ollama provider
  ansible.builtin.command:
    cmd: >-
      openclaw config set --json models.providers.ollama
      '{"baseUrl":"{{ openclaw_server_ollama_url }}","apiKey":"{{ openclaw_server_ollama_api_key }}","models":[{"id":"default","name":"Default Model"}]}'
  changed_when: false

- name: OpenclawServer | Deploy systemd service
  ansible.builtin.template:
    src: openclaw.service.j2
    dest: /etc/systemd/system/openclaw.service
    mode: "0644"
  notify: OpenclawServer | Restart OpenClaw

- name: OpenclawServer | Enable and start OpenClaw service
  ansible.builtin.systemd:
    name: openclaw
    enabled: "{{ openclaw_server_enabled }}"
    state: started
    daemon_reload: true
