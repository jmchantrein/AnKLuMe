---
# OpenclawServer | Install and configure OpenClaw AI assistant
# ADR-036: templates are framework-reproducible.
# Applied via provisioning play (connection: community.general.incus).

- name: OpenclawServer | Install curl for nodesource setup
  ansible.builtin.apt:
    name: curl
    state: present
    update_cache: true

- name: OpenclawServer | Install Node.js
  ansible.builtin.include_tasks:
    file: roles/_shared/tasks/nodejs.yml
  vars:
    _nodejs_version: "{{ openclaw_server_node_version }}"

- name: OpenclawServer | Install system dependencies
  ansible.builtin.apt:
    name:
      - git
    state: present
    update_cache: true

- name: OpenclawServer | Install OpenClaw
  ansible.builtin.command:
    cmd: npm install -g openclaw@latest
    creates: /usr/bin/openclaw

- name: OpenclawServer | Create data directory
  ansible.builtin.file:
    path: /root/.openclaw
    state: directory
    mode: "0755"

- name: OpenclawServer | Create agent workspace directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /root/.openclaw/agents/main
    - /root/.openclaw/workspace
    - /root/.openclaw/workspace/memory

- name: OpenclawServer | Build Ollama provider JSON
  ansible.builtin.set_fact:
    _openclaw_ollama_provider: >-
      {{ {"baseUrl": openclaw_server_ollama_url,
          "apiKey": openclaw_server_ollama_api_key,
          "models": [{"id": "default", "name": "Default Model"}]}
         | to_json }}

- name: OpenclawServer | Configure Ollama provider
  ansible.builtin.command:
    argv:
      - openclaw
      - config
      - set
      - --json
      - models.providers.ollama
      - "{{ _openclaw_ollama_provider }}"
  changed_when: true

- name: OpenclawServer | Build memory search JSON
  ansible.builtin.set_fact:
    _openclaw_memory_search: >-
      {{ {"provider": "openai",
          "model": openclaw_server_embeddings_model,
          "remote": {"baseUrl": "http://" ~ openclaw_server_ollama_ip ~ ":11434/v1/",
                     "apiKey": openclaw_server_ollama_api_key}}
         | to_json }}

- name: OpenclawServer | Configure memory search embeddings
  ansible.builtin.command:
    argv:
      - openclaw
      - config
      - set
      - --json
      - agents.defaults.memorySearch
      - "{{ _openclaw_memory_search }}"
  changed_when: true

# -- Git identity and credentials ------------------------------------------

- name: OpenclawServer | Configure git identity
  community.general.git_config:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - { key: "user.name", value: "{{ openclaw_server_agent_name }}" }
    - { key: "user.email", value: "{{ openclaw_server_agent_name | lower }}@anklume.local" }

- name: OpenclawServer | Check for mounted secrets
  ansible.builtin.stat:
    path: /run/secrets/git-credentials
  register: _openclaw_git_creds

- name: OpenclawServer | Configure git credential helper
  community.general.git_config:
    name: credential.helper
    value: "store --file /run/secrets/git-credentials"
    scope: global
  when: _openclaw_git_creds.stat.exists

- name: OpenclawServer | Warn if no git credentials mounted
  ansible.builtin.debug:
    msg: >-
      No GitHub credentials found at /run/secrets/git-credentials.
      {{ openclaw_server_agent_name }} cannot push to GitHub. Fix: create
      ~/.anklume/secrets/git-credentials on the host and add the
      github-creds disk device to the openclaw container.
  when: not _openclaw_git_creds.stat.exists

# -- GitHub CLI (gh) -------------------------------------------------------

- name: OpenclawServer | Install GitHub CLI
  ansible.builtin.apt:
    name: gh
    state: present

- name: OpenclawServer | Configure gh CLI auth  # noqa: risky-shell-pipe
  ansible.builtin.shell:
    cmd: |
      token=$(sed 's|.*://[^:]*:||;s|@.*||' /run/secrets/git-credentials | head -1)
      echo "$token" | gh auth login --with-token --hostname github.com
  changed_when: true
  failed_when: false
  when: _openclaw_git_creds.stat.exists

# -- Agent workspace files (ADR-036) ---------------------------------------

- name: OpenclawServer | Deploy agent instructions (AGENTS.md)
  ansible.builtin.template:
    src: AGENTS.md.j2
    dest: /root/.openclaw/agents/main/AGENTS.md
    mode: "0644"
  # force: true (default) — overwritten on every apply (ADR-036)

- name: OpenclawServer | Deploy operational workspace files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "0644"
  loop:
    - { src: "TOOLS.md.j2", dest: "/root/.openclaw/workspace/TOOLS.md" }
    - { src: "USER.md.j2", dest: "/root/.openclaw/workspace/USER.md" }
    - { src: "IDENTITY.md.j2", dest: "/root/.openclaw/workspace/IDENTITY.md" }
  # force: true (default) — overwritten on every apply (ADR-036)

- name: OpenclawServer | Seed memory file (once only)
  ansible.builtin.template:
    src: MEMORY.md.j2
    dest: /root/.openclaw/workspace/MEMORY.md
    force: false
    mode: "0644"
  # force: false — agent accumulates memory, never overwrite

- name: OpenclawServer | Deploy heartbeat monitoring (Phase 38)
  ansible.builtin.include_tasks:
    file: heartbeat.yml

# -- Webchat channel (Phase 28b) -------------------------------------------

- name: OpenclawServer | Enable webchat channel
  ansible.builtin.command:
    argv:
      - openclaw
      - config
      - set
      - gateway.channels.webchat.enabled
      - "{{ openclaw_server_webchat_enabled | string | lower }}"
  changed_when: true
  when: openclaw_server_webchat_enabled

- name: OpenclawServer | Deploy systemd service
  ansible.builtin.template:
    src: openclaw.service.j2
    dest: "/etc/systemd/system/openclaw.service"
    mode: "0644"
  notify: OpenclawServer | Restart OpenClaw

- name: OpenclawServer | Enable and start OpenClaw service
  ansible.builtin.systemd:
    name: openclaw
    enabled: "{{ openclaw_server_enabled }}"
    state: started
    daemon_reload: true
