---
- name: Verify opencode_server
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Verify | Check service file exists
      ansible.builtin.stat:
        path: /tmp/anklume-test/opencode/opencode.service
      register: verify_service_file

    - name: Verify | Service file exists
      ansible.builtin.assert:
        that:
          - verify_service_file.stat.exists
          - verify_service_file.stat.mode == '0644'
        fail_msg: "opencode.service not found or wrong permissions"

    - name: Verify | Read service file content
      ansible.builtin.slurp:
        src: /tmp/anklume-test/opencode/opencode.service
      register: verify_service_raw

    - name: Verify | Decode service content
      ansible.builtin.set_fact:
        verify_service: "{{ verify_service_raw.content | b64decode }}"

    - name: Verify | Contains ExecStart with opencode serve
      ansible.builtin.assert:
        that:
          - "'ExecStart=/usr/local/bin/opencode serve' in verify_service"
        fail_msg: "Missing ExecStart with opencode serve"

    - name: Verify | Contains correct port and host
      ansible.builtin.assert:
        that:
          - "'--port 4096' in verify_service"
          - "'--hostname 0.0.0.0' in verify_service"
        fail_msg: "Missing port/hostname configuration"

    - name: Verify | Contains password environment
      ansible.builtin.assert:
        that:
          - "'OPENCODE_SERVER_PASSWORD=opencode' in verify_service"
        fail_msg: "Missing password environment variable"

    - name: Verify | Contains systemd directives
      ansible.builtin.assert:
        that:
          - "'Restart=always' in verify_service"
          - "'WantedBy=multi-user.target' in verify_service"
        fail_msg: "Missing systemd directives"

    - name: Verify | Check config file exists
      ansible.builtin.stat:
        path: /tmp/anklume-test/opencode/config.json
      register: verify_config_file

    - name: Verify | Config file exists
      ansible.builtin.assert:
        that:
          - verify_config_file.stat.exists
        fail_msg: "config.json not found"

    - name: Verify | Read config file content
      ansible.builtin.slurp:
        src: /tmp/anklume-test/opencode/config.json
      register: verify_config_raw

    - name: Verify | Decode config content
      ansible.builtin.set_fact:
        verify_config: "{{ verify_config_raw.content | b64decode }}"

    - name: Verify | Config has correct Ollama URL
      ansible.builtin.assert:
        that:
          - "'http://localhost:11434/v1' in verify_config"
        fail_msg: "Config missing Ollama URL"

    - name: Verify | Config has correct model
      ansible.builtin.assert:
        that:
          - "'qwen2.5-coder:32b' in verify_config"
        fail_msg: "Config missing model name"

    - name: Verify | Config is valid JSON
      ansible.builtin.set_fact:
        verify_config_parsed: "{{ verify_config | from_json }}"

    - name: Verify | Config JSON has expected structure
      ansible.builtin.assert:
        that:
          - "'provider' in verify_config_parsed"
          - "'ollama' in verify_config_parsed.provider"
        fail_msg: "Config JSON structure is incorrect"

    - name: Verify | Read custom config
      ansible.builtin.slurp:
        src: /tmp/anklume-test/opencode/config-custom.json
      register: verify_custom_raw

    - name: Verify | Decode custom config
      ansible.builtin.set_fact:
        verify_custom: "{{ verify_custom_raw.content | b64decode }}"

    - name: Verify | Custom config has overridden values
      ansible.builtin.assert:
        that:
          - "'http://10.100.3.10:11434/v1' in verify_custom"
          - "'llama3.3:70b' in verify_custom"
        fail_msg: "Custom config should have overridden URL and model"

    - name: Verify | Idempotency - re-template service file
      ansible.builtin.template:
        src: "{{ lookup('env', 'MOLECULE_PROJECT_DIRECTORY') }}/templates/opencode.service.j2"
        dest: /tmp/anklume-test/opencode/opencode.service
        mode: "0644"
      vars:
        opencode_server_port: 4096
        opencode_server_host: "0.0.0.0"
        opencode_server_password: "opencode"
      register: verify_idempotency

    - name: Verify | Idempotency - no changes on second run
      ansible.builtin.assert:
        that:
          - not (verify_idempotency is changed)
        fail_msg: "Template is not idempotent â€” second run produced changes"
