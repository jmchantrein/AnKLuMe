---
# SttServer | Install and configure Speaches STT service
#
# Installs faster-whisper and the Speaches API server, which provides
# an OpenAI-compatible /v1/audio/transcriptions endpoint.
# Designed for GPU-accelerated transcription with Whisper models.

- name: SttServer | Detect GPU availability
  ansible.builtin.command:
    cmd: nvidia-smi
  register: stt_server_gpu_check
  changed_when: false
  failed_when: false

- name: SttServer | Report GPU status
  ansible.builtin.debug:
    msg: >-
      {{ 'GPU available — faster-whisper will use CUDA acceleration'
         if stt_server_gpu_check.rc == 0
         else 'No GPU detected — faster-whisper will use CPU mode' }}

- name: SttServer | Install system dependencies
  ansible.builtin.apt:
    name:
      - python3-pip
      - python3-venv
      - ffmpeg
    state: present
    update_cache: true

- name: SttServer | Install speaches via pip
  ansible.builtin.pip:
    name: speaches
    state: present
    extra_args: --break-system-packages
  register: stt_server_pip_install
  changed_when: "'Successfully installed' in (stt_server_pip_install.stdout | default(''))"

- name: SttServer | Deploy systemd service
  ansible.builtin.template:
    src: speaches.service.j2
    dest: /etc/systemd/system/speaches.service
    mode: "0644"
  notify: SttServer | Restart speaches

- name: SttServer | Enable and start speaches service
  ansible.builtin.systemd:
    name: speaches
    state: started
    enabled: "{{ stt_server_enabled }}"
    daemon_reload: true

- name: SttServer | Wait for API readiness
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ stt_server_port }}/health"
    method: GET
    status_code: 200
  register: stt_server_health
  until: stt_server_health.status == 200
  retries: 30
  delay: 2
  changed_when: false
