---
# anklume Behavior Matrix — Source of truth for expected behaviors
# Each capability lists actions at 3 depth levels with expected reactions
# LLM-generated tests verify each cell; coverage tracked automatically
#
# Depth 1: Single-feature tests (one capability in isolation)
# Depth 2: Pairwise interaction tests (two capabilities combined)
# Depth 3: Three-way interaction tests (complex scenarios)
#
# Fields:
#   id: Unique identifier (CAPABILITY-DEPTH-NNN)
#   action: What is done
#   expected: What should happen
#   deterministic: Whether the outcome is always the same (true/false)

capabilities:
  domain_lifecycle:
    description: "Domain creation, modification, deletion"
    depth_1:
      - id: DL-001
        action: "Create domain with valid subnet_id"
        expected: "inventory/, group_vars/, host_vars/ files generated"
        deterministic: true
      - id: DL-002
        action: "Duplicate subnet_id across two domains"
        expected: "Validation error mentioning subnet_id already used"
        deterministic: true
      - id: DL-003
        action: "Duplicate machine name across domains"
        expected: "Validation error mentioning duplicate machine"
        deterministic: true
      - id: DL-004
        action: "Duplicate IP across machines"
        expected: "Validation error mentioning IP already used"
        deterministic: true
      - id: DL-005
        action: "IP not in correct subnet for domain"
        expected: "Validation error mentioning not in subnet"
        deterministic: true
      - id: DL-006
        action: "Invalid domain name (uppercase, special chars)"
        expected: "Validation error mentioning invalid name"
        deterministic: true
      - id: DL-007
        action: "subnet_id out of range (255+)"
        expected: "Validation error mentioning 0-254 range"
        deterministic: true
      - id: DL-008
        action: "Reference nonexistent profile in machine"
        expected: "Validation error mentioning profile not defined"
        deterministic: true
      - id: DL-009
        action: "Reference 'default' profile (always valid)"
        expected: "No validation error"
        deterministic: true
      - id: DL-010
        action: "Empty domains list"
        expected: "Validation passes, no files generated"
        deterministic: true
      - id: DL-011
        action: "Machine without explicit IP"
        expected: "host_vars generated without instance_ip"
        deterministic: true
      - id: DL-012
        action: "Machine with config keys (limits.cpu, limits.memory)"
        expected: "host_vars contains instance_config with those keys"
        deterministic: true
    depth_2:
      - id: DL-2-001
        action: "Domain ephemeral:true + machine ephemeral:false"
        expected: "Machine overrides domain, instance_ephemeral: false"
        deterministic: true
      - id: DL-2-002
        action: "Domain ephemeral:true + machine no ephemeral"
        expected: "Machine inherits domain, instance_ephemeral: true"
        deterministic: true
      - id: DL-2-003
        action: "Domain with profiles + machine referencing them"
        expected: "group_vars has incus_profiles, host_vars has profiles list"
        deterministic: true
      - id: DL-2-004
        action: "Machine with devices and config together"
        expected: "host_vars contains both instance_devices and instance_config"
        deterministic: true
      - id: DL-2-005
        action: "Two domains with same machines but different subnets"
        expected: "Both domains generate correct files, no collision"
        deterministic: true
    depth_3:
      - id: DL-3-001
        action: "Domain + VM + GPU + firewall_mode=vm"
        expected: "anklume-firewall auto-created, VM host_vars correct, GPU tracked"
        deterministic: true
      - id: DL-3-002
        action: "3 domains, profiles, ephemeral mix, network_policies"
        expected: "All files generated, policies in all.yml, ephemeral correct"
        deterministic: true

  psot_generator:
    description: "Managed sections, idempotency, orphan detection"
    depth_1:
      - id: PG-001
        action: "Generate files for valid infra"
        expected: "All inventory, group_vars, host_vars files created"
        deterministic: true
      - id: PG-002
        action: "Run generate twice on same infra"
        expected: "Second run produces identical output (idempotent)"
        deterministic: true
      - id: PG-003
        action: "Add custom content outside managed section"
        expected: "Custom content preserved after regeneration"
        deterministic: true
      - id: PG-004
        action: "Dry-run mode"
        expected: "No files created on disk"
        deterministic: true
      - id: PG-005
        action: "Managed markers present in all generated files"
        expected: "Every .yml file has MANAGED_BEGIN and MANAGED_END"
        deterministic: true
      - id: PG-006
        action: "group_vars/all.yml contains project-level vars"
        expected: "project_name, base_subnet, psot_default_connection present"
        deterministic: true
      - id: PG-007
        action: "group_vars/domain.yml contains network config"
        expected: "net-<domain>, subnet CIDR, gateway present"
        deterministic: true
      - id: PG-008
        action: "host_vars contains instance metadata"
        expected: "instance_type, instance_ip, instance_roles present"
        deterministic: true
      - id: PG-009
        action: "No ansible_connection in group_vars (ADR-015)"
        expected: "ansible_connection and ansible_user absent from all group_vars"
        deterministic: true
      - id: PG-010
        action: "Inventory contains host and IP"
        expected: "Host listed under domain group with ansible_host"
        deterministic: true
    depth_2:
      - id: PG-2-001
        action: "Generate, add orphan files, detect orphans"
        expected: "Orphan files detected, correct count returned"
        deterministic: true
      - id: PG-2-002
        action: "Orphan with ephemeral:false (protected)"
        expected: "Orphan reported as protected, not deleted by clean"
        deterministic: true
      - id: PG-2-003
        action: "all.yml never detected as orphan"
        expected: "detect_orphans excludes all.yml"
        deterministic: true
      - id: PG-2-004
        action: "Generate + immediately detect orphans"
        expected: "Zero orphans found (no false positives)"
        deterministic: true
    depth_3:
      - id: PG-3-001
        action: "Generate + modify user content + add domain + regenerate"
        expected: "User content preserved, new domain files created"
        deterministic: true
      - id: PG-3-002
        action: "Orphan protection + clean-orphans + ephemeral mix"
        expected: "Protected orphans kept, ephemeral orphans deleted"
        deterministic: true

  gpu_policy:
    description: "GPU access policy: exclusive, shared, detection"
    depth_1:
      - id: GP-001
        action: "Single GPU instance, exclusive mode (default)"
        expected: "Validation passes"
        deterministic: true
      - id: GP-002
        action: "Two GPU instances, exclusive mode"
        expected: "Validation error listing both GPU instances"
        deterministic: true
      - id: GP-003
        action: "Two GPU instances, shared mode"
        expected: "Validation passes, warning emitted"
        deterministic: true
      - id: GP-004
        action: "Shared GPU warning message"
        expected: "get_warnings returns shared GPU warning"
        deterministic: true
      - id: GP-005
        action: "No GPU instances"
        expected: "No warnings, no errors"
        deterministic: true
      - id: GP-006
        action: "Single GPU in shared mode"
        expected: "No warning (only one instance)"
        deterministic: true
      - id: GP-007
        action: "GPU via profile device (not flag)"
        expected: "GPU detected via profile device scan"
        deterministic: true
      - id: GP-008
        action: "Invalid gpu_policy value"
        expected: "Validation error about gpu_policy"
        deterministic: true
      - id: GP-009
        action: "Default gpu_policy is exclusive"
        expected: "Two GPU instances error without explicit policy"
        deterministic: true
    depth_2:
      - id: GP-2-001
        action: "GPU via flag + GPU via profile in same infra"
        expected: "Both detected, exclusive mode errors"
        deterministic: true
      - id: GP-2-002
        action: "GPU instance + firewall_mode=vm"
        expected: "Both validated independently"
        deterministic: true
      - id: GP-2-003
        action: "Shared GPU + network_policies"
        expected: "Warning for GPU, policies validated correctly"
        deterministic: true
    depth_3:
      - id: GP-3-001
        action: "Two GPU instances + shared mode + ephemeral override"
        expected: "Warning for GPU, ephemeral correctly resolved"
        deterministic: true

  network_policies:
    description: "Cross-domain communication rules"
    depth_1:
      - id: NP-001
        action: "Valid domain-to-domain policy"
        expected: "No validation errors"
        deterministic: true
      - id: NP-002
        action: "Valid machine-to-domain policy"
        expected: "No validation errors"
        deterministic: true
      - id: NP-003
        action: "Valid 'host' keyword in from"
        expected: "No validation errors"
        deterministic: true
      - id: NP-004
        action: "ports: all"
        expected: "No validation errors"
        deterministic: true
      - id: NP-005
        action: "Unknown 'from' reference"
        expected: "Validation error about unknown from"
        deterministic: true
      - id: NP-006
        action: "Unknown 'to' reference"
        expected: "Validation error about unknown to"
        deterministic: true
      - id: NP-007
        action: "Missing 'from' field"
        expected: "Validation error about missing from"
        deterministic: true
      - id: NP-008
        action: "Missing 'to' field"
        expected: "Validation error about missing to"
        deterministic: true
      - id: NP-009
        action: "Invalid port number (>65535)"
        expected: "Validation error about invalid port"
        deterministic: true
      - id: NP-010
        action: "Invalid ports type (not list, not 'all')"
        expected: "Validation error about ports format"
        deterministic: true
      - id: NP-011
        action: "Invalid protocol (not tcp/udp)"
        expected: "Validation error about protocol"
        deterministic: true
      - id: NP-012
        action: "Empty policies list"
        expected: "No validation errors"
        deterministic: true
    depth_2:
      - id: NP-2-001
        action: "bidirectional: true policy"
        expected: "Policy accepted, no errors"
        deterministic: true
      - id: NP-2-002
        action: "Policies present in group_vars/all.yml"
        expected: "network_policies key in all.yml with rule details"
        deterministic: true
      - id: NP-2-003
        action: "No policies -> no key in all.yml"
        expected: "network_policies absent from all.yml"
        deterministic: true
      - id: NP-2-004
        action: "Policy between domain and machine within it"
        expected: "Valid (intra-domain policy accepted)"
        deterministic: true
    depth_3:
      - id: NP-3-001
        action: "Multiple policies + firewall_mode=vm + GPU shared"
        expected: "All validated independently, no interference"
        deterministic: true

  vm_support:
    description: "LXC and VM instance types"
    depth_1:
      - id: VM-001
        action: "type: vm is accepted"
        expected: "Validation passes"
        deterministic: true
      - id: VM-002
        action: "type: lxc is accepted"
        expected: "Validation passes"
        deterministic: true
      - id: VM-003
        action: "Invalid type (docker)"
        expected: "Validation error about type"
        deterministic: true
      - id: VM-004
        action: "VM produces instance_type: vm in host_vars"
        expected: "host_vars contains instance_type: vm"
        deterministic: true
      - id: VM-005
        action: "Default type is lxc"
        expected: "Machine without type gets instance_type: lxc"
        deterministic: true
      - id: VM-006
        action: "VM with resource config"
        expected: "host_vars has limits.cpu, limits.memory"
        deterministic: true
    depth_2:
      - id: VM-2-001
        action: "VM and LXC coexist in same domain"
        expected: "Both generated correctly with their types"
        deterministic: true
      - id: VM-2-002
        action: "VM with profiles"
        expected: "VM host_vars references profiles correctly"
        deterministic: true
    depth_3:
      - id: VM-3-001
        action: "VM + GPU + firewall_mode=vm"
        expected: "VM created, GPU tracked, anklume-firewall auto-created"
        deterministic: true

  privileged_policy:
    description: "Privileged LXC security based on vm_nested context"
    depth_1:
      - id: PP-001
        action: "Privileged LXC when vm_nested=false"
        expected: "Validation error about privileged forbidden"
        deterministic: true
      - id: PP-002
        action: "Privileged LXC when vm_nested=true"
        expected: "No validation error"
        deterministic: true
      - id: PP-003
        action: "Privileged LXC when vm_nested=None (file missing)"
        expected: "No enforcement (no error)"
        deterministic: true
      - id: PP-004
        action: "Privileged VM (always allowed)"
        expected: "No validation error regardless of vm_nested"
        deterministic: true
      - id: PP-005
        action: "Non-privileged LXC with vm_nested=false"
        expected: "No error (only privileged triggers)"
        deterministic: true
      - id: PP-006
        action: "YOLO bypasses privileged error"
        expected: "No error, warning about YOLO emitted"
        deterministic: true
    depth_2:
      - id: PP-2-001
        action: "Privileged LXC + YOLO + vm_nested=false"
        expected: "Warning in get_warnings, no error in validate"
        deterministic: true
      - id: PP-2-002
        action: "Privileged VM + vm_nested=false"
        expected: "VM always allowed, no error"
        deterministic: true
    depth_3:
      - id: PP-3-001
        action: "Privileged LXC + GPU + exclusive policy + vm_nested=false"
        expected: "Privileged error (GPU policy independent)"
        deterministic: true

  firewall_modes:
    description: "Host and VM firewall mode, auto-creation"
    depth_1:
      - id: FM-001
        action: "Default mode (no firewall_mode set)"
        expected: "Defaults to host mode, validation passes"
        deterministic: true
      - id: FM-002
        action: "Explicit firewall_mode: host"
        expected: "Validation passes"
        deterministic: true
      - id: FM-003
        action: "firewall_mode: vm"
        expected: "Validation passes"
        deterministic: true
      - id: FM-004
        action: "Invalid firewall_mode"
        expected: "Validation error about mode"
        deterministic: true
      - id: FM-005
        action: "firewall_mode: vm auto-creates anklume-firewall"
        expected: "anklume-firewall machine added to admin domain"
        deterministic: true
      - id: FM-006
        action: "Auto-created anklume-firewall has correct IP"
        expected: "IP is base_subnet.admin_subnet_id.253"
        deterministic: true
      - id: FM-007
        action: "Auto-created anklume-firewall has correct roles"
        expected: "roles: [base_system, firewall_router]"
        deterministic: true
      - id: FM-008
        action: "firewall_mode: vm without admin domain"
        expected: "ValueError"
        deterministic: true
    depth_2:
      - id: FM-2-001
        action: "User-declared anklume-firewall not overwritten"
        expected: "User IP and description preserved"
        deterministic: true
      - id: FM-2-002
        action: "firewall_mode: vm + network_policies"
        expected: "Both validated independently"
        deterministic: true
    depth_3:
      - id: FM-3-001
        action: "firewall_mode: vm + GPU + privileged VM"
        expected: "All features coexist, anklume-firewall created"
        deterministic: true

  infra_directory:
    description: "infra/ directory support (ADR-030)"
    depth_1:
      - id: ID-001
        action: "Load from infra/ directory"
        expected: "Same structure as single file"
        deterministic: true
      - id: ID-002
        action: "Directory and file produce identical output"
        expected: "Generated files byte-identical"
        deterministic: true
      - id: ID-003
        action: "policies.yml merged from directory"
        expected: "network_policies present in result"
        deterministic: true
      - id: ID-004
        action: "Missing base.yml raises ValueError"
        expected: "ValueError"
        deterministic: true
      - id: ID-005
        action: "Auto-detect file format"
        expected: "load_infra works with .yml extension"
        deterministic: true
      - id: ID-006
        action: "Auto-detect directory format"
        expected: "load_infra works with directory path"
        deterministic: true
      - id: ID-007
        action: "Domains sorted alphabetically"
        expected: "All domains loaded regardless of file order"
        deterministic: true
      - id: ID-008
        action: "Empty domains/ directory"
        expected: "No domains in result"
        deterministic: true
    depth_2:
      - id: ID-2-001
        action: "Directory + network_policies + domains"
        expected: "All merged correctly"
        deterministic: true
      - id: ID-2-002
        action: "Directory + firewall_mode=vm"
        expected: "Auto-creation works with directory format"
        deterministic: true
    depth_3:
      - id: ID-3-001
        action: "Directory + policies + GPU + firewall_mode=vm"
        expected: "All features work identically to single file"
        deterministic: true

  ephemeral_lifecycle:
    description: "Ephemeral flag inheritance and protection"
    depth_1:
      - id: EL-001
        action: "Domain without ephemeral (default false)"
        expected: "domain_ephemeral: false, instance_ephemeral: false"
        deterministic: true
      - id: EL-002
        action: "Domain with ephemeral: true"
        expected: "domain_ephemeral: true, machines inherit true"
        deterministic: true
      - id: EL-003
        action: "Machine override ephemeral: false on ephemeral domain"
        expected: "instance_ephemeral: false despite domain true"
        deterministic: true
      - id: EL-004
        action: "Invalid ephemeral value (string 'yes')"
        expected: "Validation error about boolean type"
        deterministic: true
      - id: EL-005
        action: "Invalid ephemeral on machine"
        expected: "Validation error about boolean type"
        deterministic: true
    depth_2:
      - id: EL-2-001
        action: "Ephemeral domain + orphan detection"
        expected: "Ephemeral orphans are unprotected"
        deterministic: true
      - id: EL-2-002
        action: "Protected orphan + clean-orphans"
        expected: "Protected orphan skipped, unprotected deleted"
        deterministic: true
    depth_3:
      - id: EL-3-001
        action: "Mixed ephemeral + GPU + network_policies"
        expected: "All features independent, ephemeral correct"
        deterministic: true

  image_management:
    description: "OS image extraction and references"
    depth_1:
      - id: IM-001
        action: "Extract images from infra with default_os_image"
        expected: "Default image in incus_all_images list"
        deterministic: true
      - id: IM-002
        action: "Machine with custom os_image"
        expected: "Custom image in extracted list"
        deterministic: true
      - id: IM-003
        action: "Multiple machines, same image"
        expected: "Deduplicated list (one entry)"
        deterministic: true
      - id: IM-004
        action: "No images defined"
        expected: "Empty list, no incus_all_images in all.yml"
        deterministic: true
    depth_2:
      - id: IM-2-001
        action: "Mix of default and custom images"
        expected: "Both in sorted list"
        deterministic: true
      - id: IM-2-002
        action: "Images in group_vars/all.yml"
        expected: "incus_all_images key present with image list"
        deterministic: true
    depth_3:
      - id: IM-3-001
        action: "Images + VM + LXC + different os_image per type"
        expected: "All unique images collected, sorted"
        deterministic: true

  ai_access_policy:
    description: "Exclusive AI-tools network access (Phase 18a)"
    depth_1:
      - id: AA-001
        action: "Valid exclusive config with known default domain"
        expected: "Validation passes, no ai_access errors"
        deterministic: true
      - id: AA-002
        action: "Exclusive mode without ai_access_default"
        expected: "Validation error: ai_access_default is required"
        deterministic: true
      - id: AA-003
        action: "ai_access_default references unknown domain"
        expected: "Validation error: not a known domain"
        deterministic: true
      - id: AA-004
        action: "ai_access_default is 'ai-tools' itself"
        expected: "Validation error: cannot be ai-tools"
        deterministic: true
      - id: AA-005
        action: "Multiple network_policies targeting ai-tools"
        expected: "Validation error: 2+ policies target ai-tools"
        deterministic: true
      - id: AA-006
        action: "Open mode (default) no AI-specific validation"
        expected: "No ai_access errors"
        deterministic: true
      - id: AA-007
        action: "Exclusive mode without ai-tools domain"
        expected: "Validation error: no ai-tools domain"
        deterministic: true
      - id: AA-008
        action: "Invalid ai_access_policy value"
        expected: "Validation error: must be exclusive or open"
        deterministic: true
      - id: AA-009
        action: "Single policy targeting ai-tools is allowed"
        expected: "No validation error about policy count"
        deterministic: true
    depth_2:
      - id: AA-2-001
        action: "Auto-creation of network_policy when none exists"
        expected: "network_policy auto-created from default to ai-tools"
        deterministic: true
      - id: AA-2-002
        action: "Auto-creation skipped when policy already exists"
        expected: "Only one ai-tools policy, no duplicate"
        deterministic: true
    depth_3:
      - id: AA-3-001
        action: "Exclusive AI + GPU exclusive + firewall_mode=vm"
        expected: "All features coexist, no interference"
        deterministic: true

  boot_autostart:
    description: "Instance boot ordering and priority on host startup"
    depth_1:
      - id: BA-001
        action: "Valid boot_autostart boolean (true/false)"
        expected: "Validation passes"
        deterministic: true
      - id: BA-002
        action: "Valid boot_priority integer (0-100)"
        expected: "Validation passes"
        deterministic: true
      - id: BA-003
        action: "boot_autostart and boot_priority written to host_vars"
        expected: "instance_boot_autostart and instance_boot_priority in host_vars"
        deterministic: true
      - id: BA-004
        action: "Invalid boot_autostart (string, int)"
        expected: "Validation error about boolean type"
        deterministic: true
      - id: BA-005
        action: "Invalid boot_priority (negative, >100, float, string)"
        expected: "Validation error about integer 0-100 range"
        deterministic: true
      - id: BA-006
        action: "Omitted boot fields"
        expected: "No errors, no instance_boot_* in host_vars"
        deterministic: true
    depth_2:
      - id: BA-2-001
        action: "boot_autostart + boot_priority on same machine"
        expected: "Both written to host_vars"
        deterministic: true
      - id: BA-2-002
        action: "boot_priority on VM and LXC"
        expected: "Both types accept boot_priority identically"
        deterministic: true
    depth_3:
      - id: BA-3-001
        action: "boot_autostart + ephemeral + resource_policy"
        expected: "All features independent, boot config correct"
        deterministic: true

  snapshots_config:
    description: "Automatic snapshot scheduling and retention"
    depth_1:
      - id: SN-001
        action: "Valid cron expression (5 fields)"
        expected: "Validation passes"
        deterministic: true
      - id: SN-002
        action: "Valid expiry duration (30d, 24h, 60m)"
        expected: "Validation passes"
        deterministic: true
      - id: SN-003
        action: "Schedule and expiry written to host_vars"
        expected: "instance_snapshots_schedule and instance_snapshots_expiry present"
        deterministic: true
      - id: SN-004
        action: "Invalid cron (wrong field count, non-string)"
        expected: "Validation error about cron expression"
        deterministic: true
      - id: SN-005
        action: "Invalid expiry (no unit, wrong unit, non-string)"
        expected: "Validation error about duration format"
        deterministic: true
      - id: SN-006
        action: "Omitted snapshot fields"
        expected: "No errors, no instance_snapshots_* in host_vars"
        deterministic: true
    depth_2:
      - id: SN-2-001
        action: "Schedule + expiry on same machine"
        expected: "Both written to host_vars independently"
        deterministic: true
    depth_3:
      - id: SN-3-001
        action: "Snapshots + ephemeral domain + boot_autostart"
        expected: "All features independent, snapshot config correct"
        deterministic: true

  nesting_prefix:
    description: "Resource name prefixing for nested anklume instances"
    depth_1:
      - id: NX-001
        action: "Valid nesting_prefix boolean"
        expected: "Validation passes"
        deterministic: true
      - id: NX-002
        action: "Prefix computation from absolute_level"
        expected: "Level 1 → 001-, level 2 → 002-, None → empty"
        deterministic: true
      - id: NX-003
        action: "Prefix applied to Incus-facing names"
        expected: "incus_project, incus_network.name, instance_name prefixed"
        deterministic: true
      - id: NX-004
        action: "Invalid nesting_prefix (string, int)"
        expected: "Validation error about boolean type"
        deterministic: true
      - id: NX-005
        action: "File paths not prefixed"
        expected: "inventory/pro.yml not 001-pro.yml"
        deterministic: true
    depth_2:
      - id: NX-2-001
        action: "Prefix disabled even with context file"
        expected: "No prefix on names when nesting_prefix: false"
        deterministic: true
      - id: NX-2-002
        action: "Prefix + shared_volumes"
        expected: "Devices use unprefixed paths, names prefixed"
        deterministic: true
    depth_3:
      - id: NX-3-001
        action: "Prefix + addressing + firewall_mode=vm"
        expected: "All names prefixed, addressing correct"
        deterministic: true

  resource_policy:
    description: "Automatic CPU and memory allocation to instances"
    depth_1:
      - id: RP-001
        action: "resource_policy: true or {} activates with defaults"
        expected: "Validation passes, allocation runs"
        deterministic: true
      - id: RP-002
        action: "host_reserve percentage validation (1-99%)"
        expected: "Valid percentages pass, 0% and 100% error"
        deterministic: true
      - id: RP-003
        action: "Machine weight validation (positive integer)"
        expected: "Valid weights pass, 0 and negative error"
        deterministic: true
      - id: RP-004
        action: "Proportional vs equal distribution modes"
        expected: "Proportional respects weights, equal ignores them"
        deterministic: true
      - id: RP-005
        action: "CPU modes (allowance % vs count vCPU)"
        expected: "Allowance sets limits.cpu.allowance, count sets limits.cpu"
        deterministic: true
      - id: RP-006
        action: "Memory enforcement (soft vs hard)"
        expected: "Soft adds limits.memory.enforce, hard does not"
        deterministic: true
      - id: RP-007
        action: "Host detection failure skips allocation"
        expected: "Warning emitted, no limits set"
        deterministic: true
      - id: RP-008
        action: "Overcommit check (false raises, true warns)"
        expected: "ValueError when false, warning when true"
        deterministic: true
    depth_2:
      - id: RP-2-001
        action: "Explicit config excluded from auto-allocation"
        expected: "Machine with limits.cpu keeps it, gets auto memory"
        deterministic: true
      - id: RP-2-002
        action: "Weighted machines across domains"
        expected: "Weight respected across all domains"
        deterministic: true
    depth_3:
      - id: RP-3-001
        action: "Resource policy + GPU + ephemeral + addressing"
        expected: "All features independent, allocation correct"
        deterministic: true

  shared_volumes:
    description: "Declarative inter-domain directory sharing via host bind mounts"
    depth_1:
      - id: SV-001
        action: "Valid shared volume with domain consumer"
        expected: "All machines in domain get sv-* disk device in host_vars"
        deterministic: true
      - id: SV-002
        action: "Valid shared volume with machine consumer"
        expected: "Only that machine gets sv-* disk device"
        deterministic: true
      - id: SV-003
        action: "Invalid volume name (uppercase, special chars)"
        expected: "Validation error about invalid name"
        deterministic: true
      - id: SV-004
        action: "Unknown consumer name"
        expected: "Validation error about unknown domain/machine"
        deterministic: true
      - id: SV-005
        action: "Invalid access mode (not ro/rw)"
        expected: "Validation error about access mode"
        deterministic: true
      - id: SV-006
        action: "Empty consumers mapping"
        expected: "Validation error about empty consumers"
        deterministic: true
      - id: SV-007
        action: "No shared_volumes section"
        expected: "No change to existing behavior"
        deterministic: true
    depth_2:
      - id: SV-2-001
        action: "Machine consumer overrides domain consumer access"
        expected: "Machine gets rw, other domain machines get ro"
        deterministic: true
      - id: SV-2-002
        action: "Shared volume + existing user devices"
        expected: "sv-* merged alongside user devices"
        deterministic: true
      - id: SV-2-003
        action: "Device name collision (user device named sv-*)"
        expected: "Validation error about device collision"
        deterministic: true
      - id: SV-2-004
        action: "Two volumes same mount path on same consumer"
        expected: "Validation error about duplicate path"
        deterministic: true
      - id: SV-2-005
        action: "Disabled domain as consumer"
        expected: "Disabled domain machines skipped"
        deterministic: true
    depth_3:
      - id: SV-3-001
        action: "Shared volumes + nesting prefix + addressing"
        expected: "Devices use correct paths, names prefixed, IPs zone-aware"
        deterministic: true

  persistent_data:
    description: "Per-machine persistent data volumes via host bind mounts"
    depth_1:
      - id: PD-001
        action: "Valid persistent_data with path"
        expected: "pd-* disk device in host_vars instance_devices"
        deterministic: true
      - id: PD-002
        action: "Invalid volume name (uppercase, special chars)"
        expected: "Validation error about invalid name"
        deterministic: true
      - id: PD-003
        action: "Missing path field"
        expected: "Validation error about required path"
        deterministic: true
      - id: PD-004
        action: "Relative path (not absolute)"
        expected: "Validation error about absolute path"
        deterministic: true
      - id: PD-005
        action: "Invalid readonly (string, int)"
        expected: "Validation error about boolean type"
        deterministic: true
      - id: PD-006
        action: "No persistent_data section"
        expected: "No change to existing behavior"
        deterministic: true
      - id: PD-007
        action: "Invalid persistent_data_base (relative path)"
        expected: "Validation error about absolute path"
        deterministic: true
    depth_2:
      - id: PD-2-001
        action: "persistent_data + shared_volumes on same machine"
        expected: "Both pd-* and sv-* devices in instance_devices"
        deterministic: true
      - id: PD-2-002
        action: "Device name collision (pd-* with user device)"
        expected: "Validation error about device collision"
        deterministic: true
    depth_3:
      - id: PD-3-001
        action: "persistent_data + shared_volumes + nesting prefix"
        expected: "All devices correct, names prefixed, paths absolute"
        deterministic: true

  student_mode:
    description: "CLI mode profiles and bilingual help (Phase 33)"
    depth_1:
      - id: SM-001
        action: "Set mode via mode-set.sh (student/user/dev)"
        expected: "Mode persisted in ~/.anklume/mode, invalid modes rejected"
        deterministic: true
      - id: SM-002
        action: "Validate i18n/fr.yml format and coverage"
        expected: "Valid YAML, all documented targets have FR translations"
        deterministic: true
      - id: SM-003
        action: "Help output differs by mode (student/user/dev)"
        expected: "Student shows French, dev shows all targets, user shows default"
        deterministic: true
      - id: SM-004
        action: "ANKLUME_LANG env var overrides default language"
        expected: "Language override works, missing file does not crash"
        deterministic: true
      - id: SM-005
        action: "Makefile mode targets exist and are functional"
        expected: "mode-student, mode-user, mode-dev in .PHONY with descriptions"
        deterministic: true
    depth_2:
      - id: SM-2-001
        action: "Mode switch + help output change"
        expected: "Switching mode changes help output on next invocation"
        deterministic: true
      - id: SM-2-002
        action: "ANKLUME_MODE env override + mode file"
        expected: "Env var takes precedence over mode file"
        deterministic: true
    depth_3:
      - id: SM-3-001
        action: "Mode switch + ANKLUME_LANG override + make help"
        expected: "ANKLUME_LANG overrides mode default, help shows correct language"
        deterministic: true

  flush_protection:
    description: "Flush respects delete protection on instances"
    depth_1:
      - id: FP-001
        action: "flush.sh skips protected instances"
        expected: "PROTECTED message, instance not deleted"
        deterministic: true
      - id: FP-002
        action: "flush.sh deletes unprotected instances"
        expected: "Instance deleted normally"
        deterministic: true
      - id: FP-003
        action: "FORCE=true bypasses protection"
        expected: "All instances deleted regardless of protection"
        deterministic: true
    depth_2:
      - id: FP-2-001
        action: "Projects with remaining instances skipped"
        expected: "Project not deleted when instances remain"
        deterministic: true
    depth_3:
      - id: FP-3-001
        action: "Flush + protected instances + FORCE override + data dirs"
        expected: "FORCE deletes all, data dirs never touched"
        deterministic: true

  educational_labs:
    description: "Educational lab framework, lab.yml validation, lab runner"
    depth_1:
      - id: ED-001
        action: "Validate lab.yml against schema (required fields, enums)"
        expected: "All lab.yml files pass schema validation"
        deterministic: true
      - id: ED-002
        action: "Validate step structure (IDs, instruction files, sequence)"
        expected: "All steps have required fields, files exist, IDs sequential"
        deterministic: true
      - id: ED-003
        action: "Lab-runner CLI argument parsing (list, start, errors)"
        expected: "list succeeds, missing args error, unknown lab errors"
        deterministic: true
      - id: ED-004
        action: "Lab infra.yml files are valid PSOT definitions"
        expected: "Each lab has infra.yml with project_name, domains, addressing"
        deterministic: true
      - id: ED-005
        action: "Solution files exist and have bash shebang"
        expected: "Each lab has solution/commands.sh with correct shebang"
        deterministic: true
    depth_2:
      - id: ED-2-001
        action: "Lab start + check integration (progress advances)"
        expected: "Starting lab sets step 0, checking advances when validation passes"
        deterministic: true
      - id: ED-2-002
        action: "Lab runner + progress persistence (reset clears state)"
        expected: "Reset removes progress file, start creates fresh state"
        deterministic: true
    depth_3:
      - id: ED-3-001
        action: "Lab start + check + solution (marks as assisted)"
        expected: "Solution marks assisted:true in progress, step still tracked"
        deterministic: true

  heartbeat_monitoring:
    description: "OpenClaw heartbeat monitoring templates and skills (Phase 38)"
    depth_1:
      - id: HB-001
        action: "HEARTBEAT.md.j2 template renders with domain variables"
        expected: "Domain name and project injected, thresholds present"
        deterministic: true
      - id: HB-002
        action: "CRON.md.j2 template renders with schedule variables"
        expected: "Daily hour/minute and project name present in output"
        deterministic: true
      - id: HB-003
        action: "Heartbeat tasks file deploys all templates"
        expected: "heartbeat.yml deploys HEARTBEAT, CRON, and both skills"
        deterministic: true
      - id: HB-004
        action: "Heartbeat defaults present in role defaults"
        expected: "All heartbeat variables have sensible defaults"
        deterministic: true
      - id: HB-005
        action: "Skill templates render with correct Incus project"
        expected: "Both skills contain --project flag with domain project"
        deterministic: true
    depth_2:
      - id: HB-2-001
        action: "Heartbeat + domain-scoped monitoring only"
        expected: "Agent monitors only its own domain project"
        deterministic: true
    depth_3:
      - id: HB-3-001
        action: "Heartbeat + openclaw + domain trust level"
        expected: "Heartbeat adapts to domain trust, monitoring scoped"
        deterministic: true

  llm_sanitizer:
    description: "LLM sanitization proxy — ai_provider/ai_sanitize validation and patterns (Phase 39)"
    depth_1:
      - id: LS-001
        action: "Valid ai_provider values (local, cloud, local-first)"
        expected: "Validation passes for all three values"
        deterministic: true
      - id: LS-002
        action: "Invalid ai_provider value"
        expected: "Validation error mentioning ai_provider"
        deterministic: true
      - id: LS-003
        action: "Valid ai_sanitize values (true, false, 'always')"
        expected: "Validation passes for all three values"
        deterministic: true
      - id: LS-004
        action: "Invalid ai_sanitize value"
        expected: "Validation error mentioning ai_sanitize"
        deterministic: true
      - id: LS-005
        action: "Default propagation (local->false, cloud->true)"
        expected: "group_vars contains correct domain_ai_provider and domain_ai_sanitize"
        deterministic: true
      - id: LS-006
        action: "Explicit ai_sanitize overrides auto-default"
        expected: "group_vars contains user-specified ai_sanitize value"
        deterministic: true
      - id: LS-007
        action: "IaC detection patterns match infrastructure identifiers"
        expected: "Regex patterns match anklume IPs, Incus names, FQDNs, credentials"
        deterministic: true
    depth_2:
      - id: LS-2-001
        action: "Sanitization + domain trust level interaction"
        expected: "Trust-aware sanitization defaults applied correctly"
        deterministic: true
    depth_3:
      - id: LS-3-001
        action: "Sanitization + ai_provider + network_policies"
        expected: "All features independent, sanitization config correct"
        deterministic: true

  network_inspection:
    description: "LLM-assisted network inspection per domain (Phase 40)"
    depth_1:
      - id: NI-001
        action: "Network triage skill template renders with domain variables"
        expected: "Domain name, project, and LLM URL injected correctly"
        deterministic: true
      - id: NI-002
        action: "Inventory diff skill template renders with baseline dir"
        expected: "Baseline dir and project name present in output"
        deterministic: true
      - id: NI-003
        action: "PCAP summary skill template renders with domain context"
        expected: "Domain name and project injected, tshark commands present"
        deterministic: true
      - id: NI-004
        action: "nmap-diff.sh passes shellcheck validation"
        expected: "Zero shellcheck warnings at severity=warning level"
        deterministic: true
      - id: NI-005
        action: "Network anonymization patterns match expected identifiers"
        expected: "MAC addresses, interface names, ARP entries matched"
        deterministic: true
    depth_2:
      - id: NI-2-001
        action: "Heartbeat tasks deploy all 5 skills (2 existing + 3 new)"
        expected: "heartbeat.yml references all 5 skill template files"
        deterministic: true
    depth_3:
      - id: NI-3-001
        action: "Network inspection + heartbeat + network scan cron"
        expected: "CRON.md includes network scan when enabled, skills deployed"
        deterministic: true

  galaxy_roles:
    description: "Official Galaxy role integration and vendor roles (Phase 41)"
    depth_1:
      - id: GR-001
        action: "requirements.yml contains roles section"
        expected: "File has both collections and roles keys"
        deterministic: true
      - id: GR-002
        action: "ansible.cfg has three-tier roles_path"
        expected: "roles_path includes roles_custom, roles, roles_vendor in order"
        deterministic: true
      - id: GR-003
        action: "roles_vendor/ is gitignored"
        expected: ".gitignore contains /roles_vendor/ entry"
        deterministic: true
      - id: GR-004
        action: "ADR-045 exists in ARCHITECTURE.md"
        expected: "ADR-045 documents Galaxy role integration decision"
        deterministic: true
      - id: GR-005
        action: "SPEC.md documents role resolution order"
        expected: "Three directories listed with priority order"
        deterministic: true
    depth_2:
      - id: GR-2-001
        action: "roles_path priority resolves custom > native > vendor"
        expected: "ansible.cfg roles_path is roles_custom/:roles/:roles_vendor/"
        deterministic: true
    depth_3:
      - id: GR-3-001
        action: "make init installs Galaxy roles to roles_vendor/"
        expected: "Makefile init target creates roles_vendor/ and conditionally installs roles"
        deterministic: true

  desktop_plugin:
    description: "Desktop environment plugin system (Phase 42)"
    depth_1:
      - id: DP-001
        action: "Plugin directory structure exists"
        expected: "plugins/desktop/ with plugin.schema.yml"
        deterministic: true
      - id: DP-002
        action: "Plugin schema defines required interface"
        expected: "Schema specifies detect.sh, apply.sh, reset capabilities"
        deterministic: true
      - id: DP-003
        action: "Desktop plugin script validates plugin structure"
        expected: "scripts/desktop-plugin.sh discovers and validates plugins"
        deterministic: true
      - id: DP-004
        action: "Reference plugin implements detect.sh"
        expected: "At least one plugin has a working detect.sh"
        deterministic: true
      - id: DP-005
        action: "Reference plugin implements apply.sh"
        expected: "At least one plugin has apply.sh that reads JSON config"
        deterministic: true
    depth_2:
      - id: DP-2-001
        action: "Plugin framework discovers all installed plugins"
        expected: "desktop-plugin.sh list shows all plugins in plugins/desktop/"
        deterministic: true
    depth_3:
      - id: DP-3-001
        action: "Sway plugin apply.sh generates working config from JSON"
        expected: "apply.sh --dry-run with domain config produces valid Sway snippets"
        deterministic: true

  gui_forwarding:
    description: "GUI app forwarding via Wayland/X11/GPU proxy devices (Phase 19b)"
    depth_1:
      - id: GF-001
        action: "domain-exec.sh detects host Wayland socket"
        expected: "Script references wayland-0 socket path"
        deterministic: true
      - id: GF-002
        action: "domain-exec.sh sets up Wayland proxy device"
        expected: "anklume-wl proxy device created for Wayland socket"
        deterministic: true
      - id: GF-003
        action: "domain-exec.sh sets up X11 proxy device"
        expected: "anklume-x11 proxy device for .X11-unix socket"
        deterministic: true
      - id: GF-004
        action: "domain-exec.sh adds GPU device to container"
        expected: "anklume-gpu gpu device added"
        deterministic: true
      - id: GF-005
        action: "domain-exec.sh sets display environment variables"
        expected: "WAYLAND_DISPLAY, XDG_RUNTIME_DIR, DISPLAY set"
        deterministic: true
      - id: GF-006
        action: "domain-exec.sh warns on untrusted/disposable GUI"
        expected: "Security warning on stderr for untrusted and disposable domains"
        deterministic: true
